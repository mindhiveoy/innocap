"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[149],{15751:(e,t,n)=>{n.d(t,{GG:()=>lY,H9:()=>o2,aQ:()=>lZ,aU:()=>o6,rJ:()=>o1});var r,i,s,a,o=n(54495),l=n(77827),u=n(24464),h=n(75270),c=n(32039),d=n(56331),f=n(40459),m=n(93414).Buffer;let g="@firebase/firestore",p="4.7.7";class y{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}y.UNAUTHENTICATED=new y(null),y.GOOGLE_CREDENTIALS=new y("google-credentials-uid"),y.FIRST_PARTY=new y("first-party-uid"),y.MOCK_USER=new y("mock-user");let w="11.3.0",v=new u.Vy("@firebase/firestore");function I(){return v.logLevel}function T(e,...t){if(v.logLevel<=u.$b.DEBUG){let n=t.map(b);v.debug(`Firestore (${w}): ${e}`,...n)}}function E(e,...t){if(v.logLevel<=u.$b.ERROR){let n=t.map(b);v.error(`Firestore (${w}): ${e}`,...n)}}function _(e,...t){if(v.logLevel<=u.$b.WARN){let n=t.map(b);v.warn(`Firestore (${w}): ${e}`,...n)}}function b(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function x(e="Unexpected state"){let t=`FIRESTORE (${w}) INTERNAL ASSERTION FAILED: `+e;throw E(t),Error(t)}let S={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class N extends h.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class C{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class D{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class k{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(y.UNAUTHENTICATED))}shutdown(){}}class A{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class V{constructor(e){this.t=e,this.currentUser=y.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){void 0===this.o||x();let n=this.i,r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve(),i=new C;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new C,e.enqueueRetryable(()=>r(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},a=e=>{T("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(T("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new C)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(T("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?("string"==typeof t.accessToken||x(),new D(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return null===e||"string"==typeof e||x(),new y(e)}}class R{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=y.FIRST_PARTY,this.T=new Map}I(){return this.P?this.P():null}get headers(){this.T.set("X-Goog-AuthUser",this.l);let e=this.I();return e&&this.T.set("Authorization",e),this.h&&this.T.set("X-Goog-Iam-Authorization-Token",this.h),this.T}}class L{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new R(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(y.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class M{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class O{constructor(e,t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null,this.V=null,(0,o.xZ)(e)&&e.settings.appCheckToken&&(this.V=e.settings.appCheckToken)}start(e,t){void 0===this.o||x();let n=e=>{null!=e.error&&T("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let n=e.token!==this.R;return this.R=e.token,T("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};let r=e=>{T("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){let e=this.A.getImmediate({optional:!0});e?r(e):T("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.V)return Promise.resolve(new M(this.V));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?("string"==typeof e.token||x(),this.R=e.token,new M(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}function F(){return new TextEncoder}class P{static newId(){let e=62*Math.floor(256/62),t="";for(;t.length<20;){let n=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let e=0;e<40;e++)n[e]=Math.floor(256*Math.random());return n}(0);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function U(e,t){return e<t?-1:e>t?1:0}function q(e,t){let n=F().encode(e),r=F().encode(t);for(let e=0;e<Math.min(n.length,r.length);e++){let t=U(n[e],r[e]);if(0!==t)return t}return U(n.length,r.length)}function B(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}class z{static now(){return z.fromMillis(Date.now())}static fromDate(e){return z.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),n=Math.floor((e-1e3*t)*1e6);return new z(t,n)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new N(S.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new N(S.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?U(this.nanoseconds,e.nanoseconds):U(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ${static fromTimestamp(e){return new $(e)}static min(){return new $(new z(0,0))}static max(){return new $(new z(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}let K="__name__";class G{constructor(e,t,n){void 0===t?t=0:t>e.length&&x(),void 0===n?n=e.length-t:n>e.length-t&&x(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===G.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof G?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=G.compareSegments(e.get(r),t.get(r));if(0!==n)return n}return U(e.length,t.length)}static compareSegments(e,t){let n=G.isNumericId(e),r=G.isNumericId(t);return n&&!r?-1:!n&&r?1:n&&r?G.extractNumericId(e).compare(G.extractNumericId(t)):q(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return c.jz.fromString(e.substring(4,e.length-2))}}class j extends G{construct(e,t,n){return new j(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let n of e){if(n.indexOf("//")>=0)throw new N(S.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new j(t)}static emptyPath(){return new j([])}}let Q=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class H extends G{construct(e,t,n){return new H(e,t,n)}static isValidIdentifier(e){return Q.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),H.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===K}static keyField(){return new H([K])}static fromServerFormat(e){let t=[],n="",r=0,i=()=>{if(0===n.length)throw new N(S.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""},s=!1;for(;r<e.length;){let t=e[r];if("\\"===t){if(r+1===e.length)throw new N(S.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new N(S.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new N(S.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new H(t)}static emptyPath(){return new H([])}}class W{constructor(e){this.path=e}static fromPath(e){return new W(j.fromString(e))}static fromName(e){return new W(j.fromString(e).popFirst(5))}static empty(){return new W(j.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===j.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return j.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new W(new j(e.slice()))}}class Y{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function Z(e){return e.fields.find(e=>2===e.kind)}function J(e){return e.fields.filter(e=>2!==e.kind)}Y.UNKNOWN_ID=-1;class X{constructor(e,t){this.fieldPath=e,this.kind=t}}class ee{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new ee(0,er.min())}}function et(e,t){let n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return new er($.fromTimestamp(1e9===r?new z(n+1,0):new z(n,r)),W.empty(),t)}function en(e){return new er(e.readTime,e.key,-1)}class er{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new er($.min(),W.empty(),-1)}static max(){return new er($.max(),W.empty(),-1)}}function ei(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:0!==(n=W.comparator(e.documentKey,t.documentKey))?n:U(e.largestBatchId,t.largestBatchId)}let es="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ea{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function eo(e){if(e.code!==S.FAILED_PRECONDITION||e.message!==es)throw e;T("LocalStore","Unexpectedly lost primary lease")}class el{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&x(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new el((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof el?t:el.resolve(t)}catch(e){return el.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):el.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):el.reject(t)}static resolve(e){return new el((t,n)=>{t(e)})}static reject(e){return new el((t,n)=>{n(e)})}static waitFor(e){return new el((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=el.resolve(!1);for(let n of e)t=t.next(e=>e?el.resolve(e):n());return t}static forEach(e,t){let n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new el((n,r)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&n(s)},e=>r(e))}})}static doWhile(e,t){return new el((n,r)=>{let i=()=>{!0===e()?t().next(()=>{i()},r):n()};i()})}}let eu="SimpleDb";class eh{static open(e,t,n,r){try{return new eh(t,e.transaction(r,n))}catch(e){throw new em(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.m=new C,this.transaction.oncomplete=()=>{this.m.resolve()},this.transaction.onabort=()=>{t.error?this.m.reject(new em(e,t.error)):this.m.resolve()},this.transaction.onerror=t=>{let n=ev(t.target.error);this.m.reject(new em(e,n))}}get p(){return this.m.promise}abort(e){e&&this.m.reject(e),this.aborted||(T(eu,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}S(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new ep(this.transaction.objectStore(e))}}class ec{static delete(e){return T(eu,"Removing database:",e),ey(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,h.zW)())return!1;if(ec.v())return!0;let e=(0,h.ZQ)(),t=ec.C(e),n=ed(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<n&&n<4.5)}static v(){var e;return void 0!==f&&"YES"===(null===(e=f.__PRIVATE_env)||void 0===e?void 0:e.F)}static M(e,t){return e.store(t)}static C(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}constructor(e,t,n){this.name=e,this.version=t,this.O=n,12.2===ec.C((0,h.ZQ)())&&E("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async N(e){return this.db||(T(eu,"Opening database:",this.name),this.db=await new Promise((t,n)=>{let r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{t(e.target.result)},r.onblocked=()=>{n(new em(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{let r=t.target.error;"VersionError"===r.name?n(new N(S.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new N(S.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new em(e,r))},r.onupgradeneeded=e=>{T(eu,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.O.B(t,r.transaction,e.oldVersion,this.version).next(()=>{T(eu,"Database upgrade to version "+this.version+" complete")})}})),this.L&&(this.db.onversionchange=e=>this.L(e)),this.db}k(e){this.L=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.N(e);let t=eh.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.S(),e)).catch(e=>(t.abort(e),el.reject(e))).toPromise();return s.catch(()=>{}),await t.p,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(T(eu,"Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function ed(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class ef{constructor(e){this.q=e,this.$=!1,this.U=null}get isDone(){return this.$}get K(){return this.U}set cursor(e){this.q=e}done(){this.$=!0}W(e){this.U=e}delete(){return ey(this.q.delete())}}class em extends N{constructor(e,t){super(S.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function eg(e){return"IndexedDbTransactionError"===e.name}class ep{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(T(eu,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(T(eu,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),ey(n)}add(e){return T(eu,"ADD",this.store.name,e,e),ey(this.store.add(e))}get(e){return ey(this.store.get(e)).next(t=>(void 0===t&&(t=null),T(eu,"GET",this.store.name,e,t),t))}delete(e){return T(eu,"DELETE",this.store.name,e),ey(this.store.delete(e))}count(){return T(eu,"COUNT",this.store.name),ey(this.store.count())}G(e,t){let n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){let e=r.getAll(n.range);return new el((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(n),t=[];return this.j(e,(e,n)=>{t.push(n)}).next(()=>t)}}H(e,t){let n=this.store.getAll(e,null===t?void 0:t);return new el((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}J(e,t){T(eu,"DELETE ALL",this.store.name);let n=this.options(e,t);n.Y=!1;let r=this.cursor(n);return this.j(r,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);let r=this.cursor(n);return this.j(r,t)}X(e){let t=this.cursor({});return new el((n,r)=>{t.onerror=e=>{r(ev(e.target.error))},t.onsuccess=t=>{let r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}j(e,t){let n=[];return new el((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void r();let s=new ef(i),a=t(i.primaryKey,i.value,s);if(a instanceof el){let e=a.catch(e=>(s.done(),el.reject(e)));n.push(e)}s.isDone?r():null===s.K?i.continue():i.continue(s.K)}}).next(()=>el.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function ey(e){return new el((t,n)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{n(ev(e.target.error))}})}let ew=!1;function ev(e){let t=ec.C((0,h.ZQ)());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new N("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ew||(ew=!0,setTimeout(()=>{throw e},0)),e}}return e}let eI="IndexBackfiller";class eT{constructor(e,t){this.asyncQueue=e,this.ee=t,this.task=null}start(){this.te(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}te(e){T(eI,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{let e=await this.ee.ne();T(eI,`Documents written: ${e}`)}catch(e){eg(e)?T(eI,"Ignoring IndexedDB error during index backfill: ",e):await eo(e)}await this.te(6e4)})}}class eE{constructor(e,t){this.localStore=e,this.persistence=t}async ne(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.re(t,e))}re(e,t){let n=new Set,r=t,i=!0;return el.doWhile(()=>!0===i&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return T(eI,`Processing collection: ${t}`),this.ie(e,t,r).next(e=>{r-=e,n.add(t)});i=!1})).next(()=>t-r)}ie(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{let i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this.se(r,n)).next(n=>(T(eI,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>i.size)}))}se(e,t){let n=e;return t.changes.forEach((e,t)=>{let r=en(t);ei(r,n)>0&&(n=r)}),new er(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class e_{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.oe(e),this._e=e=>t.writeSequenceNumber(e))}oe(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this._e&&this._e(e),e}}function eb(e){return null==e}function ex(e){return 0===e&&1/e==-1/0}function eS(e){return"number"==typeof e&&Number.isInteger(e)&&!ex(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function eN(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let n=t,r=e.length;for(let t=0;t<r;t++){let r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=r}}return n}(e.get(n),t);return t+"\x01\x01"}function eC(e){let t=e.length;if(t>=2||x(),2===t)return"\x01"===e.charAt(0)&&"\x01"===e.charAt(1)||x(),j.emptyPath();let n=t-2,r=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>n)&&x(),e.charAt(t+1)){case"\x01":let a;let o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),r.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:x()}s=t+2}return new j(r)}e_.ae=-1;let eD="remoteDocuments",ek="owner",eA="owner",eV="mutationQueues",eR="mutations",eL="batchId",eM="userMutationsIndex",eO=["userId","batchId"],eF={},eP="documentMutations",eU="remoteDocumentsV14",eq=["prefixPath","collectionGroup","readTime","documentId"],eB="documentKeyIndex",ez=["prefixPath","collectionGroup","documentId"],e$="collectionGroupIndex",eK=["collectionGroup","readTime","prefixPath","documentId"],eG="remoteDocumentGlobal",ej="remoteDocumentGlobalKey",eQ="targets",eH="queryTargetsIndex",eW=["canonicalId","targetId"],eY="targetDocuments",eZ=["targetId","path"],eJ="documentTargetsIndex",eX=["path","targetId"],e0="targetGlobalKey",e1="targetGlobal",e2="collectionParents",e5=["collectionId","parent"],e3="clientMetadata",e4="bundles",e8="namedQueries",e6="indexConfiguration",e9="collectionGroupIndex",e7="indexState",te=["indexId","uid"],tt="sequenceNumberIndex",tn=["uid","sequenceNumber"],tr="indexEntries",ti=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],ts="documentKeyIndex",ta=["indexId","uid","orderedDocumentKey"],to="documentOverlays",tl=["userId","collectionPath","documentId"],tu="collectionPathOverlayIndex",th=["userId","collectionPath","largestBatchId"],tc="collectionGroupOverlayIndex",td=["userId","collectionGroup","largestBatchId"],tf="globals",tm=[eV,eR,eP,eD,eQ,ek,e1,eY,e3,eG,e2,e4,e8],tg=[...tm,to],tp=[eV,eR,eP,eU,eQ,ek,e1,eY,e3,eG,e2,e4,e8,to],ty=[...tp,e6,e7,tr],tw=[...ty,tf];class tv extends ea{constructor(e,t){super(),this.ue=e,this.currentSequenceNumber=t}}function tI(e,t){return ec.M(e.ue,t)}function tT(e){let t=0;for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function tE(e,t){for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function t_(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tb{constructor(e,t){this.comparator=e,this.root=t||tS.EMPTY}insert(e,t){return new tb(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,tS.BLACK,null,null))}remove(e){return new tb(this.comparator,this.root.remove(e,this.comparator).copy(null,null,tS.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){let r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){let e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new tx(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new tx(this.root,e,this.comparator,!1)}getReverseIterator(){return new tx(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new tx(this.root,e,this.comparator,!0)}}class tx{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class tS{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:tS.RED,this.left=null!=r?r:tS.EMPTY,this.right=null!=i?i:tS.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new tS(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return tS.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(0>t(e,r.key))r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return tS.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,tS.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,tS.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw x();let e=this.left.check();if(e!==this.right.check())throw x();return e+(this.isRed()?0:1)}}tS.EMPTY=null,tS.RED=!0,tS.BLACK=!1,tS.EMPTY=new class{constructor(){this.size=0}get key(){throw x()}get value(){throw x()}get color(){throw x()}get left(){throw x()}get right(){throw x()}copy(e,t,n,r,i){return this}insert(e,t,n){return new tS(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tN{constructor(e){this.comparator=e,this.data=new tb(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){let n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){let r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tC(this.data.getIterator())}getIteratorFrom(e){return new tC(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof tN)||this.size!==e.size)return!1;let t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new tN(this.comparator);return t.data=e,t}}class tC{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function tD(e){return e.hasNext()?e.getNext():void 0}class tk{constructor(e){this.fields=e,e.sort(H.comparator)}static empty(){return new tk([])}unionWith(e){let t=new tN(H.comparator);for(let e of this.fields)t=t.add(e);for(let n of e)t=t.add(n);return new tk(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return B(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class tA extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class tV{constructor(e){this.binaryString=e}static fromBase64String(e){return new tV(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new tA("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new tV(function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){return function(e){let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return U(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}tV.EMPTY_BYTE_STRING=new tV("");let tR=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function tL(e){if(e||x(),"string"==typeof e){let t=0,n=tR.exec(e);if(n||x(),n[1]){let e=n[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:tM(e.seconds),nanos:tM(e.nanos)}}function tM(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function tO(e){return"string"==typeof e?tV.fromBase64String(e):tV.fromUint8Array(e)}let tF="server_timestamp",tP="__type__",tU="__previous_value__",tq="__local_write_time__";function tB(e){var t,n;return(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{})[tP])||void 0===n?void 0:n.stringValue)===tF}function tz(e){let t=e.mapValue.fields[tU];return tB(t)?tz(t):t}function t$(e){let t=tL(e.mapValue.fields[tq].timestampValue);return new z(t.seconds,t.nanos)}class tK{constructor(e,t,n,r,i,s,a,o,l){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l}}let tG="(default)";class tj{constructor(e,t){this.projectId=e,this.database=t||tG}static empty(){return new tj("","")}get isDefaultDatabase(){return this.database===tG}isEqual(e){return e instanceof tj&&e.projectId===this.projectId&&e.database===this.database}}let tQ="__type__",tH="__max__",tW={mapValue:{fields:{__type__:{stringValue:tH}}}},tY="__vector__",tZ="value",tJ={nullValue:"NULL_VALUE"};function tX(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?tB(e)?4:ni(e)?0x1fffffffffffff:nn(e)?10:11:x()}function t0(e,t){if(e===t)return!0;let n=tX(e);if(n!==tX(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return t$(e).isEqual(t$(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let n=tL(e.timestampValue),r=tL(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return tO(e.bytesValue).isEqual(tO(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return tM(e.geoPointValue.latitude)===tM(t.geoPointValue.latitude)&&tM(e.geoPointValue.longitude)===tM(t.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return tM(e.integerValue)===tM(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let n=tM(e.doubleValue),r=tM(t.doubleValue);return n===r?ex(n)===ex(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return B(e.arrayValue.values||[],t.arrayValue.values||[],t0);case 10:case 11:return function(e,t){let n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(tT(n)!==tT(r))return!1;for(let e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!t0(n[e],r[e])))return!1;return!0}(e,t);default:return x()}}function t1(e,t){return void 0!==(e.values||[]).find(e=>t0(e,t))}function t2(e,t){if(e===t)return 0;let n=tX(e),r=tX(t);if(n!==r)return U(n,r);switch(n){case 0:case 0x1fffffffffffff:return 0;case 1:return U(e.booleanValue,t.booleanValue);case 2:return function(e,t){let n=tM(e.integerValue||e.doubleValue),r=tM(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return t5(e.timestampValue,t.timestampValue);case 4:return t5(t$(e),t$(t));case 5:return q(e.stringValue,t.stringValue);case 6:return function(e,t){let n=tO(e),r=tO(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){let t=U(n[e],r[e]);if(0!==t)return t}return U(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let n=U(tM(e.latitude),tM(t.latitude));return 0!==n?n:U(tM(e.longitude),tM(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return t3(e.arrayValue,t.arrayValue);case 10:return function(e,t){var n,r,i,s;let a=e.fields||{},o=t.fields||{},l=null===(n=a[tZ])||void 0===n?void 0:n.arrayValue,u=null===(r=o[tZ])||void 0===r?void 0:r.arrayValue,h=U((null===(i=null==l?void 0:l.values)||void 0===i?void 0:i.length)||0,(null===(s=null==u?void 0:u.values)||void 0===s?void 0:s.length)||0);return 0!==h?h:t3(l,u)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===tW.mapValue&&t===tW.mapValue)return 0;if(e===tW.mapValue)return 1;if(t===tW.mapValue)return -1;let n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){let t=q(r[e],s[e]);if(0!==t)return t;let a=t2(n[r[e]],i[s[e]]);if(0!==a)return a}return U(r.length,s.length)}(e.mapValue,t.mapValue);default:throw x()}}function t5(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return U(e,t);let n=tL(e),r=tL(t),i=U(n.seconds,r.seconds);return 0!==i?i:U(n.nanos,r.nanos)}function t3(e,t){let n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){let t=t2(n[e],r[e]);if(t)return t}return U(n.length,r.length)}function t4(e){var t,n;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=tL(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?tO(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,W.fromName(t).toString()):"geoPointValue"in e?(n=e.geoPointValue,`geo(${n.latitude},${n.longitude})`):"arrayValue"in e?function(e){let t="[",n=!0;for(let r of e.values||[])n?n=!1:t+=",",t+=t4(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),n="{",r=!0;for(let i of t)r?r=!1:n+=",",n+=`${i}:${t4(e.fields[i])}`;return n+"}"}(e.mapValue):x()}function t8(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function t6(e){return!!e&&"integerValue"in e}function t9(e){return!!e&&"arrayValue"in e}function t7(e){return!!e&&"nullValue"in e}function ne(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function nt(e){return!!e&&"mapValue"in e}function nn(e){var t,n;return(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{})[tQ])||void 0===n?void 0:n.stringValue)===tY}function nr(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){let t={mapValue:{fields:{}}};return tE(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=nr(n)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=nr(e.arrayValue.values[n]);return t}return Object.assign({},e)}function ni(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===tH}let ns={mapValue:{fields:{[tQ]:{stringValue:tY},[tZ]:{arrayValue:{}}}}};function na(e,t){let n=t2(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function no(e,t){let n=t2(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class nl{constructor(e){this.value=e}static empty(){return new nl({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(!nt(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=nr(t)}setAll(e){let t=H.emptyPath(),n={},r=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=nr(e):r.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){let t=this.field(e.popLast());nt(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return t0(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];nt(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){for(let r of(tE(t,(t,n)=>e[t]=n),n))delete e[r]}clone(){return new nl(nr(this.value))}}class nu{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new nu(e,0,$.min(),$.min(),$.min(),nl.empty(),0)}static newFoundDocument(e,t,n,r){return new nu(e,1,t,$.min(),n,r,0)}static newNoDocument(e,t){return new nu(e,2,t,$.min(),$.min(),nl.empty(),0)}static newUnknownDocument(e,t){return new nu(e,3,t,$.min(),$.min(),nl.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual($.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=nl.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=nl.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=$.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof nu&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new nu(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class nh{constructor(e,t){this.position=e,this.inclusive=t}}function nc(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(r=s.field.isKeyField()?W.comparator(W.fromName(a.referenceValue),n.key):t2(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function nd(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!t0(e.position[n],t.position[n]))return!1;return!0}class nf{constructor(e,t="asc"){this.field=e,this.dir=t}}class nm{}class ng extends nm{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new nE(e,t,n):"array-contains"===t?new nS(e,n):"in"===t?new nN(e,n):"not-in"===t?new nC(e,n):"array-contains-any"===t?new nD(e,n):new ng(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new n_(e,n):new nb(e,n)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(t2(t,this.value)):null!==t&&tX(this.value)===tX(t)&&this.matchesComparison(t2(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return x()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class np extends nm{constructor(e,t){super(),this.filters=e,this.op=t,this.ce=null}static create(e,t){return new np(e,t)}matches(e){return ny(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.ce||(this.ce=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ce}getFilters(){return Object.assign([],this.filters)}}function ny(e){return"and"===e.op}function nw(e){return"or"===e.op}function nv(e){return nI(e)&&ny(e)}function nI(e){for(let t of e.filters)if(t instanceof np)return!1;return!0}function nT(e,t){let n=e.filters.concat(t);return np.create(n,e.op)}class nE extends ng{constructor(e,t,n){super(e,t,n),this.key=W.fromName(n.referenceValue)}matches(e){let t=W.comparator(e.key,this.key);return this.matchesComparison(t)}}class n_ extends ng{constructor(e,t){super(e,"in",t),this.keys=nx("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class nb extends ng{constructor(e,t){super(e,"not-in",t),this.keys=nx("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function nx(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>W.fromName(e.referenceValue))}class nS extends ng{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return t9(t)&&t1(t.arrayValue,this.value)}}class nN extends ng{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&t1(this.value.arrayValue,t)}}class nC extends ng{constructor(e,t){super(e,"not-in",t)}matches(e){if(t1(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&!t1(this.value.arrayValue,t)}}class nD extends ng{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!t9(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>t1(this.value.arrayValue,e))}}class nk{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.le=null}}function nA(e,t=null,n=[],r=[],i=null,s=null,a=null){return new nk(e,t,n,r,i,s,a)}function nV(e){if(null===e.le){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof ng)return t.field.canonicalString()+t.op.toString()+t4(t.value);if(nv(t))return t.filters.map(t=>e(t)).join(",");{let n=t.filters.map(t=>e(t)).join(",");return`${t.op}(${n})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),null==e.limit||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>t4(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>t4(e)).join(",")),e.le=t}return e.le}function nR(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var n,r;if(n=e.orderBy[i],r=t.orderBy[i],!(n.dir===r.dir&&n.field.isEqual(r.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof ng?n instanceof ng&&t.op===n.op&&t.field.isEqual(n.field)&&t0(t.value,n.value):t instanceof np?n instanceof np&&t.op===n.op&&t.filters.length===n.filters.length&&t.filters.reduce((t,r,i)=>t&&e(r,n.filters[i]),!0):void x()}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!nd(e.startAt,t.startAt)&&nd(e.endAt,t.endAt)}function nL(e){return W.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function nM(e,t){return e.filters.filter(e=>e instanceof ng&&e.field.isEqual(t))}function nO(e,t,n){let r=tJ,i=!0;for(let n of nM(e,t)){let e=tJ,t=!0;switch(n.op){case"<":case"<=":var s;e="nullValue"in(s=n.value)?tJ:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?t8(tj.empty(),W.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?nn(s)?ns:{mapValue:{}}:x();break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=tJ}0>na({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];0>na({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}function nF(e,t,n){let r=tW,i=!0;for(let n of nM(e,t)){let e=tW,t=!0;switch(n.op){case">=":case">":var s;e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?t8(tj.empty(),W.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?ns:"mapValue"in s?nn(s)?{mapValue:{}}:tW:x(),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=tW}no({value:r,inclusive:i},{value:e,inclusive:t})>0&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];no({value:r,inclusive:i},{value:e,inclusive:n.inclusive})>0&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}class nP{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.he=null,this.Pe=null,this.Te=null,this.startAt,this.endAt}}function nU(e){return new nP(e)}function nq(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function nB(e){return null!==e.collectionGroup}function nz(e){if(null===e.he){let t;e.he=[];let n=new Set;for(let t of e.explicitOrderBy)e.he.push(t),n.add(t.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new tN(H.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{n.has(t.canonicalString())||t.isKeyField()||e.he.push(new nf(t,r))}),n.has(H.keyField().canonicalString())||e.he.push(new nf(H.keyField(),r))}return e.he}function n$(e){return e.Pe||(e.Pe=function(e,t){if("F"===e.limitType)return nA(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new nf(e.field,t)});let n=e.endAt?new nh(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new nh(e.startAt.position,e.startAt.inclusive):null;return nA(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}(e,nz(e))),e.Pe}function nK(e,t){let n=e.filters.concat([t]);return new nP(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function nG(e,t,n){return new nP(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function nj(e,t){return nR(n$(e),n$(t))&&e.limitType===t.limitType}function nQ(e){return`${nV(n$(e))}|lt:${e.limitType}`}function nH(e){var t;let n;return`Query(target=${n=(t=n$(e)).path.canonicalString(),null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof ng?`${t.field.canonicalString()} ${t.op} ${t4(t.value)}`:t instanceof np?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),null==t.limit||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(e=>t4(e)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(e=>t4(e)).join(",")),`Target(${n})`}; limitType=${e.limitType})`}function nW(e,t){return t.isFoundDocument()&&function(e,t){let n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):W.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(let n of nz(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(let n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,n){let r=nc(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,nz(e),t))&&(!e.endAt||!!function(e,t,n){let r=nc(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,nz(e),t))}function nY(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function nZ(e){return(t,n)=>{let r=!1;for(let i of nz(e)){let e=function(e,t,n){let r=e.field.isKeyField()?W.comparator(t.key,n.key):function(e,t,n){let r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?t2(r,i):x()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return -1*r;default:return x()}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class nJ{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(let[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){let n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){tE(this.inner,(t,n)=>{for(let[t,r]of n)e(t,r)})}isEmpty(){return t_(this.inner)}size(){return this.innerSize}}let nX=new tb(W.comparator),n0=new tb(W.comparator);function n1(...e){let t=n0;for(let n of e)t=t.insert(n.key,n);return t}function n2(e){let t=n0;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function n5(){return new nJ(e=>e.toString(),(e,t)=>e.isEqual(t))}let n3=new tb(W.comparator),n4=new tN(W.comparator);function n8(...e){let t=n4;for(let n of e)t=t.add(n);return t}let n6=new tN(U);function n9(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ex(t)?"-0":t}}function n7(e){return{integerValue:""+e}}function re(e,t){return eS(t)?n7(t):n9(e,t)}class rt{constructor(){this._=void 0}}function rn(e,t){return e instanceof rl?t6(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class rr extends rt{}class ri extends rt{constructor(e){super(),this.elements=e}}function rs(e,t){let n=rh(t);for(let t of e.elements)n.some(e=>t0(e,t))||n.push(t);return{arrayValue:{values:n}}}class ra extends rt{constructor(e){super(),this.elements=e}}function ro(e,t){let n=rh(t);for(let t of e.elements)n=n.filter(e=>!t0(e,t));return{arrayValue:{values:n}}}class rl extends rt{constructor(e,t){super(),this.serializer=e,this.Ie=t}}function ru(e){return tM(e.integerValue||e.doubleValue)}function rh(e){return t9(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class rc{constructor(e,t){this.field=e,this.transform=t}}class rd{constructor(e,t){this.version=e,this.transformResults=t}}class rf{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new rf}static exists(e){return new rf(void 0,e)}static updateTime(e){return new rf(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function rm(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class rg{}function rp(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new rb(e.key,rf.none()):new rv(e.key,e.data,rf.none());{let n=e.data,r=nl.empty(),i=new tN(H.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new rI(e.key,r,new tk(i.toArray()),rf.none())}}function ry(e,t,n,r){return e instanceof rv?function(e,t,n,r){if(!rm(e.precondition,t))return n;let i=e.value.clone(),s=r_(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof rI?function(e,t,n,r){if(!rm(e.precondition,t))return n;let i=r_(e.fieldTransforms,r,t),s=t.data;return(s.setAll(rT(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n)?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):rm(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function rw(e,t){var n,r;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||!(!n||!r)&&B(n,r,(e,t)=>{var n,r;return e.field.isEqual(t.field)&&(n=e.transform,r=t.transform,n instanceof ri&&r instanceof ri||n instanceof ra&&r instanceof ra?B(n.elements,r.elements,t0):n instanceof rl&&r instanceof rl?t0(n.Ie,r.Ie):n instanceof rr&&r instanceof rr)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class rv extends rg{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class rI extends rg{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function rT(e){let t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){let r=e.data.field(n);t.set(n,r)}}),t}function rE(e,t,n){var r;let i=new Map;e.length===n.length||x();for(let s=0;s<n.length;s++){let a=e[s],o=a.transform,l=t.data.field(a.field);i.set(a.field,(r=n[s],o instanceof ri?rs(o,l):o instanceof ra?ro(o,l):r))}return i}function r_(e,t,n){let r=new Map;for(let i of e){let e=i.transform,s=n.data.field(i.field);r.set(i.field,e instanceof rr?function(e,t){let n={fields:{[tP]:{stringValue:tF},[tq]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&tB(t)&&(t=tz(t)),t&&(n.fields[tU]=t),{mapValue:n}}(t,s):e instanceof ri?rs(e,s):e instanceof ra?ro(e,s):function(e,t){let n=rn(e,t),r=ru(n)+ru(e.Ie);return t6(n)&&t6(e.Ie)?n7(r):n9(e.serializer,r)}(e,s))}return r}class rb extends rg{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class rx extends rg{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class rS{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){let n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let i=this.mutations[t];if(i.key.isEqual(e.key)){var r;r=n[t],i instanceof rv?function(e,t,n){let r=e.value.clone(),i=rE(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(i,e,r):i instanceof rI?function(e,t,n){if(!rm(e.precondition,t))return void t.convertToUnknownDocument(n.version);let r=rE(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(rT(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(i,e,r):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,r)}}}applyToLocalView(e,t){for(let n of this.baseMutations)n.key.isEqual(e.key)&&(t=ry(n,e,t,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(e.key)&&(t=ry(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let n=n5();return this.mutations.forEach(r=>{let i=e.get(r.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=rp(s,a=t.has(r.key)?null:a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument($.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),n8())}isEqual(e){return this.batchId===e.batchId&&B(this.mutations,e.mutations,(e,t)=>rw(e,t))&&B(this.baseMutations,e.baseMutations,(e,t)=>rw(e,t))}}class rN{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){e.mutations.length===n.length||x();let r=n3,i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new rN(e,t,n,r)}}class rC{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class rD{constructor(e,t){this.count=e,this.unchangedNames=t}}function rk(e){if(void 0===e)return E("GRPC error has no .code"),S.UNKNOWN;switch(e){case r.OK:return S.OK;case r.CANCELLED:return S.CANCELLED;case r.UNKNOWN:return S.UNKNOWN;case r.DEADLINE_EXCEEDED:return S.DEADLINE_EXCEEDED;case r.RESOURCE_EXHAUSTED:return S.RESOURCE_EXHAUSTED;case r.INTERNAL:return S.INTERNAL;case r.UNAVAILABLE:return S.UNAVAILABLE;case r.UNAUTHENTICATED:return S.UNAUTHENTICATED;case r.INVALID_ARGUMENT:return S.INVALID_ARGUMENT;case r.NOT_FOUND:return S.NOT_FOUND;case r.ALREADY_EXISTS:return S.ALREADY_EXISTS;case r.PERMISSION_DENIED:return S.PERMISSION_DENIED;case r.FAILED_PRECONDITION:return S.FAILED_PRECONDITION;case r.ABORTED:return S.ABORTED;case r.OUT_OF_RANGE:return S.OUT_OF_RANGE;case r.UNIMPLEMENTED:return S.UNIMPLEMENTED;case r.DATA_LOSS:return S.DATA_LOSS;default:return x()}}(i=r||(r={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let rA=new c.jz([0xffffffff,0xffffffff],0);function rV(e){let t=F().encode(e),n=new c.VV;return n.update(t),new Uint8Array(n.digest())}function rR(e){let t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new c.jz([n,r],0),new c.jz([i,s],0)]}class rL{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new rM(`Invalid padding: ${t}`);if(n<0||e.length>0&&0===this.hashCount)throw new rM(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new rM(`Invalid padding when bitmap length is 0: ${t}`);this.Ee=8*e.length-t,this.de=c.jz.fromNumber(this.Ee)}Ae(e,t,n){let r=e.add(t.multiply(c.jz.fromNumber(n)));return 1===r.compare(rA)&&(r=new c.jz([r.getBits(0),r.getBits(1)],0)),r.modulo(this.de).toNumber()}Re(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ee)return!1;let[t,n]=rR(rV(e));for(let e=0;e<this.hashCount;e++){let r=this.Ae(t,n,e);if(!this.Re(r))return!1}return!0}static create(e,t,n){let r=new rL(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return n.forEach(e=>r.insert(e)),r}insert(e){if(0===this.Ee)return;let[t,n]=rR(rV(e));for(let e=0;e<this.hashCount;e++){let r=this.Ae(t,n,e);this.Ve(r)}}Ve(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class rM extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class rO{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){let r=new Map;return r.set(e,rF.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new rO($.min(),r,new tb(U),nX,n8())}}class rF{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new rF(n,t,n8(),n8(),n8())}}class rP{constructor(e,t,n,r){this.me=e,this.removedTargetIds=t,this.key=n,this.fe=r}}class rU{constructor(e,t){this.targetId=e,this.ge=t}}class rq{constructor(e,t,n=tV.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class rB{constructor(){this.pe=0,this.ye=rK(),this.we=tV.EMPTY_BYTE_STRING,this.Se=!1,this.be=!0}get current(){return this.Se}get resumeToken(){return this.we}get De(){return 0!==this.pe}get ve(){return this.be}Ce(e){e.approximateByteSize()>0&&(this.be=!0,this.we=e)}Fe(){let e=n8(),t=n8(),n=n8();return this.ye.forEach((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:x()}}),new rF(this.we,this.Se,e,t,n)}Me(){this.be=!1,this.ye=rK()}xe(e,t){this.be=!0,this.ye=this.ye.insert(e,t)}Oe(e){this.be=!0,this.ye=this.ye.remove(e)}Ne(){this.pe+=1}Be(){this.pe-=1,this.pe>=0||x()}Le(){this.be=!0,this.Se=!0}}class rz{constructor(e){this.ke=e,this.qe=new Map,this.Qe=nX,this.$e=r$(),this.Ue=r$(),this.Ke=new tb(U)}We(e){for(let t of e.me)e.fe&&e.fe.isFoundDocument()?this.Ge(t,e.fe):this.ze(t,e.key,e.fe);for(let t of e.removedTargetIds)this.ze(t,e.key,e.fe)}je(e){this.forEachTarget(e,t=>{let n=this.He(t);switch(e.state){case 0:this.Je(t)&&n.Ce(e.resumeToken);break;case 1:n.Be(),n.De||n.Me(),n.Ce(e.resumeToken);break;case 2:n.Be(),n.De||this.removeTarget(t);break;case 3:this.Je(t)&&(n.Le(),n.Ce(e.resumeToken));break;case 4:this.Je(t)&&(this.Ye(t),n.Ce(e.resumeToken));break;default:x()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.qe.forEach((e,n)=>{this.Je(n)&&t(n)})}Ze(e){let t=e.targetId,n=e.ge.count,r=this.Xe(t);if(r){let i=r.target;if(nL(i)){if(0===n){let e=new W(i.path);this.ze(t,e,nu.newNoDocument(e,$.min()))}else 1===n||x()}else{let r=this.et(t);if(r!==n){let n=this.tt(e),i=n?this.nt(n,e,r):1;0!==i&&(this.Ye(t),this.Ke=this.Ke.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch"))}}}}tt(e){let t,n;let r=e.ge.unchangedNames;if(!r||!r.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=r;try{t=tO(i).toUint8Array()}catch(e){if(e instanceof tA)return _("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{n=new rL(t,s,a)}catch(e){return _(e instanceof rM?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===n.Ee?null:n}nt(e,t,n){return t.ge.count===n-this.st(e,t.targetId)?0:2}st(e,t){let n=this.ke.getRemoteKeysForTarget(t),r=0;return n.forEach(n=>{let i=this.ke.it(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.ze(t,n,null),r++)}),r}ot(e){let t=new Map;this.qe.forEach((n,r)=>{let i=this.Xe(r);if(i){if(n.current&&nL(i.target)){let t=new W(i.target.path);this._t(t).has(r)||this.ut(r,t)||this.ze(r,t,nu.newNoDocument(t,e))}n.ve&&(t.set(r,n.Fe()),n.Me())}});let n=n8();this.Ue.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{let t=this.Xe(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.Qe.forEach((t,n)=>n.setReadTime(e));let r=new rO(e,t,this.Ke,this.Qe,n);return this.Qe=nX,this.$e=r$(),this.Ue=r$(),this.Ke=new tb(U),r}Ge(e,t){if(!this.Je(e))return;let n=this.ut(e,t.key)?2:0;this.He(e).xe(t.key,n),this.Qe=this.Qe.insert(t.key,t),this.$e=this.$e.insert(t.key,this._t(t.key).add(e)),this.Ue=this.Ue.insert(t.key,this.ct(t.key).add(e))}ze(e,t,n){if(!this.Je(e))return;let r=this.He(e);this.ut(e,t)?r.xe(t,1):r.Oe(t),this.Ue=this.Ue.insert(t,this.ct(t).delete(e)),this.Ue=this.Ue.insert(t,this.ct(t).add(e)),n&&(this.Qe=this.Qe.insert(t,n))}removeTarget(e){this.qe.delete(e)}et(e){let t=this.He(e).Fe();return this.ke.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ne(e){this.He(e).Ne()}He(e){let t=this.qe.get(e);return t||(t=new rB,this.qe.set(e,t)),t}ct(e){let t=this.Ue.get(e);return t||(t=new tN(U),this.Ue=this.Ue.insert(e,t)),t}_t(e){let t=this.$e.get(e);return t||(t=new tN(U),this.$e=this.$e.insert(e,t)),t}Je(e){let t=null!==this.Xe(e);return t||T("WatchChangeAggregator","Detected inactive target",e),t}Xe(e){let t=this.qe.get(e);return t&&t.De?null:this.ke.lt(e)}Ye(e){this.qe.set(e,new rB),this.ke.getRemoteKeysForTarget(e).forEach(t=>{this.ze(e,t,null)})}ut(e,t){return this.ke.getRemoteKeysForTarget(e).has(t)}}function r$(){return new tb(W.comparator)}function rK(){return new tb(W.comparator)}let rG={asc:"ASCENDING",desc:"DESCENDING"},rj={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},rQ={and:"AND",or:"OR"};class rH{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function rW(e,t){return e.useProto3Json||null==t?t:{value:t}}function rY(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function rZ(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function rJ(e){return e||x(),$.fromTimestamp(function(e){let t=tL(e);return new z(t.seconds,t.nanos)}(e))}function rX(e,t){return r0(e,t).canonicalString()}function r0(e,t){let n=new j(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?n:n.child(t)}function r1(e){let t=j.fromString(e);return il(t)||x(),t}function r2(e,t){return rX(e.databaseId,t.path)}function r5(e,t){let n=r1(t);if(n.get(1)!==e.databaseId.projectId)throw new N(S.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new N(S.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new W(r6(n))}function r3(e,t){return rX(e.databaseId,t)}function r4(e){let t=r1(e);return 4===t.length?j.emptyPath():r6(t)}function r8(e){return new j(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function r6(e){return e.length>4&&"documents"===e.get(4)||x(),e.popFirst(5)}function r9(e,t,n){return{name:r2(e,t),fields:n.value.mapValue.fields}}function r7(e,t,n){let r=r5(e,t.name),i=rJ(t.updateTime),s=t.createTime?rJ(t.createTime):$.min(),a=new nl({mapValue:{fields:t.fields}}),o=nu.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function ie(e,t){var n;let r;if(t instanceof rv)r={update:r9(e,t.key,t.value)};else if(t instanceof rb)r={delete:r2(e,t.key)};else if(t instanceof rI)r={update:r9(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof rx))return x();r={verify:r2(e,t.key)}}return t.fieldTransforms.length>0&&(r.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let n=t.transform;if(n instanceof rr)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof ri)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof ra)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof rl)return{fieldPath:t.field.canonicalString(),increment:n.Ie};throw x()})(0,e))),t.precondition.isNone||(r.currentDocument=void 0!==(n=t.precondition).updateTime?{updateTime:rY(e,n.updateTime.toTimestamp())}:void 0!==n.exists?{exists:n.exists}:x()),r}function it(e,t){var n;let r=t.currentDocument?void 0!==(n=t.currentDocument).updateTime?rf.updateTime(rJ(n.updateTime)):void 0!==n.exists?rf.exists(n.exists):rf.none():rf.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{let n;return n=null,"setToServerValue"in t?("REQUEST_TIME"===t.setToServerValue||x(),n=new rr):"appendMissingElements"in t?n=new ri(t.appendMissingElements.values||[]):"removeAllFromArray"in t?n=new ra(t.removeAllFromArray.values||[]):"increment"in t?n=new rl(e,t.increment):x(),new rc(H.fromServerFormat(t.fieldPath),n)}):[];if(t.update){t.update.name;let n=r5(e,t.update.name),s=new nl({mapValue:{fields:t.update.fields}});return t.updateMask?new rI(n,s,new tk((t.updateMask.fieldPaths||[]).map(e=>H.fromServerFormat(e))),r,i):new rv(n,s,r,i)}return t.delete?new rb(r5(e,t.delete),r):t.verify?new rx(r5(e,t.verify),r):x()}function ir(e,t){return{documents:[r3(e,t.path)]}}function ii(e,t){var n,r;let i;let s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=r3(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof ng?function(e){if("=="===e.op){if(ne(e.value))return{unaryFilter:{field:ia(e.field),op:"IS_NAN"}};if(t7(e.value))return{unaryFilter:{field:ia(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(ne(e.value))return{unaryFilter:{field:ia(e.field),op:"IS_NOT_NAN"}};if(t7(e.value))return{unaryFilter:{field:ia(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ia(e.field),op:rj[e.op],value:e.value}}}(t):t instanceof np?function(t){let n=t.getFilters().map(t=>e(t));return 1===n.length?n[0]:{compositeFilter:{op:rQ[t.op],filters:n}}}(t):x()}(np.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:ia(e.field),direction:rG[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=rW(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(n=t.startAt).inclusive,values:n.position}),t.endAt&&(s.structuredQuery.endAt={before:!(r=t.endAt).inclusive,values:r.position}),{ht:s,parent:i}}function is(e){var t;let n,r=r4(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){1===s||x();let e=i.from[0];e.allDescendants?a=e.collectionId:r=r.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=io(e.unaryFilter.field);return ng.create(t,"==",{doubleValue:NaN});case"IS_NULL":let n=io(e.unaryFilter.field);return ng.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let r=io(e.unaryFilter.field);return ng.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=io(e.unaryFilter.field);return ng.create(i,"!=",{nullValue:"NULL_VALUE"});default:return x()}}(t):void 0!==t.fieldFilter?ng.create(io(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return x()}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?np.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return x()}}(t.compositeFilter.op)):x()}(e);return t instanceof np&&nv(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new nf(io(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=null==(n="object"==typeof(t=i.limit)?t.value:t)?null:n);let h=null;i.startAt&&(h=function(e){let t=!!e.before;return new nh(e.values||[],t)}(i.startAt));let c=null;return i.endAt&&(c=function(e){let t=!e.before;return new nh(e.values||[],t)}(i.endAt)),new nP(r,a,l,o,u,"F",h,c)}function ia(e){return{fieldPath:e.canonicalString()}}function io(e){return H.fromServerFormat(e.fieldPath)}function il(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class iu{constructor(e,t,n,r,i=$.min(),s=$.min(),a=tV.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new iu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new iu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new iu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new iu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class ih{constructor(e){this.Tt=e}}function ic(e,t){let n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:id(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;r.document={name:r2(i=e.Tt,t.key),fields:t.data.value.mapValue.fields,updateTime:rY(i,t.version.toTimestamp()),createTime:rY(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:im(t.version)};else{if(!t.isUnknownDocument())return x();r.unknownDocument={path:n.path.toArray(),version:im(t.version)}}return r}function id(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function im(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function ig(e){let t=new z(e.seconds,e.nanoseconds);return $.fromTimestamp(t)}function ip(e,t){let n=(t.baseMutations||[]).map(t=>it(e.Tt,t));for(let e=0;e<t.mutations.length-1;++e){let n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){let r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}let r=t.mutations.map(t=>it(e.Tt,t)),i=z.fromMillis(t.localWriteTimeMs);return new rS(t.batchId,i,n,r)}function iy(e){var t;let n=ig(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?ig(e.lastLimboFreeSnapshotVersion):$.min();return new iu(void 0!==e.query.documents?(1===(t=e.query).documents.length||x(),n$(nU(r4(t.documents[0])))):n$(is(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,n,r,tV.fromBase64String(e.resumeToken))}function iw(e,t){let n;let r=im(t.snapshotVersion),i=im(t.lastLimboFreeSnapshotVersion);n=nL(t.target)?ir(e.Tt,t.target):ii(e.Tt,t.target).ht;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:nV(t.target),readTime:r,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:n}}function iv(e){let t=is({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?nG(t,t.limit,"L"):t}function iI(e,t){return new rC(t.largestBatchId,it(e.Tt,t.overlayMutation))}function iT(e,t){let n=t.path.lastSegment();return[e,eN(t.path.popLast()),n]}function iE(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:im(r.readTime),documentKey:eN(r.documentKey.path),largestBatchId:r.largestBatchId}}class i_{getBundleMetadata(e,t){return tI(e,e4).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:ig(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return tI(e,e4).put({bundleId:t.id,createTime:im(rJ(t.createTime)),version:t.version})}getNamedQuery(e,t){return tI(e,e8).get(t).next(e=>{if(e)return{name:e.name,query:iv(e.bundledQuery),readTime:ig(e.readTime)}})}saveNamedQuery(e,t){return tI(e,e8).put({name:t.name,readTime:im(rJ(t.readTime)),bundledQuery:t.bundledQuery})}}class ib{constructor(e,t){this.serializer=e,this.userId=t}static It(e,t){return new ib(e,t.uid||"")}getOverlay(e,t){return tI(e,to).get(iT(this.userId,t)).next(e=>e?iI(this.serializer,e):null)}getOverlays(e,t){let n=n5();return el.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){let r=[];return n.forEach((n,i)=>{let s=new rC(t,i);r.push(this.Et(e,s))}),el.waitFor(r)}removeOverlaysForBatchId(e,t,n){let r=new Set;t.forEach(e=>r.add(eN(e.getCollectionPath())));let i=[];return r.forEach(t=>{let r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(tI(e,to).J(tu,r))}),el.waitFor(i)}getOverlaysForCollection(e,t,n){let r=n5(),i=eN(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return tI(e,to).G(tu,s).next(e=>{for(let t of e){let e=iI(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){let i;let s=n5(),a=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return tI(e,to).Z({index:tc,range:a},(e,t,n)=>{let a=iI(this.serializer,t);s.size()<r||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):n.done()}).next(()=>s)}Et(e,t){return tI(e,to).put(function(e,t,n){let[r,i,s]=iT(t,n.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:ie(e.Tt,n.mutation)}}(this.serializer,this.userId,t))}}class ix{dt(e){return tI(e,tf)}getSessionToken(e){return this.dt(e).get("sessionToken").next(e=>{let t=null==e?void 0:e.value;return t?tV.fromUint8Array(t):tV.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.dt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class iS{constructor(){}At(e,t){this.Rt(e,t),t.Vt()}Rt(e,t){if("nullValue"in e)this.ft(t,5);else if("booleanValue"in e)this.ft(t,10),t.gt(e.booleanValue?1:0);else if("integerValue"in e)this.ft(t,15),t.gt(tM(e.integerValue));else if("doubleValue"in e){let n=tM(e.doubleValue);isNaN(n)?this.ft(t,13):(this.ft(t,15),ex(n)?t.gt(0):t.gt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.ft(t,20),"string"==typeof n&&(n=tL(n)),t.yt(`${n.seconds||""}`),t.gt(n.nanos||0)}else if("stringValue"in e)this.wt(e.stringValue,t),this.St(t);else if("bytesValue"in e)this.ft(t,30),t.bt(tO(e.bytesValue)),this.St(t);else if("referenceValue"in e)this.Dt(e.referenceValue,t);else if("geoPointValue"in e){let n=e.geoPointValue;this.ft(t,45),t.gt(n.latitude||0),t.gt(n.longitude||0)}else"mapValue"in e?ni(e)?this.ft(t,Number.MAX_SAFE_INTEGER):nn(e)?this.vt(e.mapValue,t):(this.Ct(e.mapValue,t),this.St(t)):"arrayValue"in e?(this.Ft(e.arrayValue,t),this.St(t)):x()}wt(e,t){this.ft(t,25),this.Mt(e,t)}Mt(e,t){t.yt(e)}Ct(e,t){let n=e.fields||{};for(let e of(this.ft(t,55),Object.keys(n)))this.wt(e,t),this.Rt(n[e],t)}vt(e,t){var n,r;let i=e.fields||{};this.ft(t,53);let s=(null===(r=null===(n=i[tZ].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.length)||0;this.ft(t,15),t.gt(tM(s)),this.wt(tZ,t),this.Rt(i[tZ],t)}Ft(e,t){let n=e.values||[];for(let e of(this.ft(t,50),n))this.Rt(e,t)}Dt(e,t){this.ft(t,37),W.fromName(e).path.forEach(e=>{this.ft(t,60),this.Mt(e,t)})}ft(e,t){e.gt(t)}St(e){e.gt(2)}}function iN(e){return Math.ceil((64-function(e){let t=0;for(let n=0;n<8;++n){let r=function(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}(255&e[n]);if(t+=r,8!==r)break}return t}(e))/8)}iS.xt=new iS;class iC{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ot(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Nt(n.value),n=t.next();this.Bt()}Lt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.kt(n.value),n=t.next();this.qt()}Qt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Nt(e);else if(e<2048)this.Nt(960|e>>>6),this.Nt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Nt(480|e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e);else{let e=t.codePointAt(0);this.Nt(240|e>>>18),this.Nt(128|63&e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e)}}this.Bt()}$t(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.kt(e);else if(e<2048)this.kt(960|e>>>6),this.kt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.kt(480|e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e);else{let e=t.codePointAt(0);this.kt(240|e>>>18),this.kt(128|63&e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e)}}this.qt()}Ut(e){let t=this.Kt(e),n=iN(t);this.Wt(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Gt(e){let t=this.Kt(e),n=iN(t);this.Wt(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}zt(){this.jt(255),this.jt(255)}Ht(){this.Jt(255),this.Jt(255)}reset(){this.position=0}seed(e){this.Wt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Yt(){return this.buffer.slice(0,this.position)}Kt(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Nt(e){let t=255&e;0===t?(this.jt(0),this.jt(255)):255===t?(this.jt(255),this.jt(0)):this.jt(t)}kt(e){let t=255&e;0===t?(this.Jt(0),this.Jt(255)):255===t?(this.Jt(255),this.Jt(0)):this.Jt(e)}Bt(){this.jt(0),this.jt(1)}qt(){this.Jt(0),this.Jt(1)}jt(e){this.Wt(1),this.buffer[this.position++]=e}Jt(e){this.Wt(1),this.buffer[this.position++]=~e}Wt(e){let t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);let r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class iD{constructor(e){this.Zt=e}bt(e){this.Zt.Ot(e)}yt(e){this.Zt.Qt(e)}gt(e){this.Zt.Ut(e)}Vt(){this.Zt.zt()}}class ik{constructor(e){this.Zt=e}bt(e){this.Zt.Lt(e)}yt(e){this.Zt.$t(e)}gt(e){this.Zt.Gt(e)}Vt(){this.Zt.Ht()}}class iA{constructor(){this.Zt=new iC,this.Xt=new iD(this.Zt),this.en=new ik(this.Zt)}seed(e){this.Zt.seed(e)}tn(e){return 0===e?this.Xt:this.en}Yt(){return this.Zt.Yt()}reset(){this.Zt.reset()}}class iV{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}nn(){let e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new iV(this.indexId,this.documentKey,this.arrayValue,n)}}function iR(e,t){let n=e.indexId-t.indexId;return 0!==n?n:0!==(n=iL(e.arrayValue,t.arrayValue))?n:0!==(n=iL(e.directionalValue,t.directionalValue))?n:W.comparator(e.documentKey,t.documentKey)}function iL(e,t){for(let n=0;n<e.length&&n<t.length;++n){let r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class iM{constructor(e){for(let t of(this.rn=new tN((e,t)=>H.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.sn=e.orderBy,this._n=[],e.filters))t.isInequality()?this.rn=this.rn.add(t):this._n.push(t)}get an(){return this.rn.size>1}un(e){if(e.collectionGroup===this.collectionId||x(),this.an)return!1;let t=Z(e);if(void 0!==t&&!this.cn(t))return!1;let n=J(e),r=new Set,i=0,s=0;for(;i<n.length&&this.cn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(this.rn.size>0){let e=this.rn.getIterator().getNext();if(!r.has(e.field.canonicalString())){let t=n[i];if(!this.ln(e,t)||!this.hn(this.sn[s++],t))return!1}++i}for(;i<n.length;++i){let e=n[i];if(s>=this.sn.length||!this.hn(this.sn[s++],e))return!1}return!0}Pn(){if(this.an)return null;let e=new tN(H.comparator),t=[];for(let n of this._n)if(!n.field.isKeyField()){if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new X(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new X(n.field,0))}}for(let n of this.sn)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new X(n.field,"asc"===n.dir?0:1)));return new Y(Y.UNKNOWN_ID,this.collectionId,t,ee.empty())}cn(e){for(let t of this._n)if(this.ln(t,e))return!0;return!1}ln(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}hn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function iO(e){return e instanceof ng}function iF(e){return e instanceof np&&nv(e)}function iP(e){return iO(e)||iF(e)||function(e){if(e instanceof np&&nw(e)){for(let t of e.getFilters())if(!iO(t)&&!iF(t))return!1;return!0}return!1}(e)}function iU(e,t){return e instanceof ng||e instanceof np||x(),t instanceof ng||t instanceof np||x(),iB(e instanceof ng?t instanceof ng?np.create([e,t],"and"):iq(e,t):t instanceof ng?iq(t,e):function(e,t){if(e.filters.length>0&&t.filters.length>0||x(),ny(e)&&ny(t))return nT(e,t.getFilters());let n=nw(e)?e:t,r=nw(e)?t:e,i=n.filters.map(e=>iU(e,r));return np.create(i,"or")}(e,t))}function iq(e,t){if(ny(t))return nT(t,e.getFilters());{let n=t.filters.map(t=>iU(e,t));return np.create(n,"or")}}function iB(e){if(e instanceof ng||e instanceof np||x(),e instanceof ng)return e;let t=e.getFilters();if(1===t.length)return iB(t[0]);if(nI(e))return e;let n=t.map(e=>iB(e)),r=[];return n.forEach(t=>{t instanceof ng?r.push(t):t instanceof np&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:np.create(r,e.op)}class iz{constructor(){this.Tn=new i$}addToCollectionParentIndex(e,t){return this.Tn.add(t),el.resolve()}getCollectionParents(e,t){return el.resolve(this.Tn.getEntries(t))}addFieldIndex(e,t){return el.resolve()}deleteFieldIndex(e,t){return el.resolve()}deleteAllFieldIndexes(e){return el.resolve()}createTargetIndexes(e,t){return el.resolve()}getDocumentsMatchingTarget(e,t){return el.resolve(null)}getIndexType(e,t){return el.resolve(0)}getFieldIndexes(e,t){return el.resolve([])}getNextCollectionGroupToUpdate(e){return el.resolve(null)}getMinOffset(e,t){return el.resolve(er.min())}getMinOffsetFromCollectionGroup(e,t){return el.resolve(er.min())}updateCollectionGroup(e,t,n){return el.resolve()}updateIndexEntries(e,t){return el.resolve()}}class i${constructor(){this.index={}}add(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new tN(j.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new tN(j.comparator)).toArray()}}let iK="IndexedDbIndexManager",iG=new Uint8Array(0);class ij{constructor(e,t){this.databaseId=t,this.In=new i$,this.En=new nJ(e=>nV(e),(e,t)=>nR(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.In.has(t)){let n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.In.add(t)});let i={collectionId:n,parent:eN(r)};return tI(e,e2).put(i)}return el.resolve()}getCollectionParents(e,t){let n=[],r=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return tI(e,e2).G(r).next(e=>{for(let r of e){if(r.collectionId!==t)break;n.push(eC(r.parent))}return n})}addFieldIndex(e,t){let n=tI(e,e6),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;let i=n.add(r);if(t.indexState){let n=tI(e,e7);return i.next(e=>{n.put(iE(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let n=tI(e,e6),r=tI(e,e7),i=tI(e,tr);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=tI(e,e6),n=tI(e,tr),r=tI(e,e7);return t.J().next(()=>n.J()).next(()=>r.J())}createTargetIndexes(e,t){return el.forEach(this.dn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){let n=new iM(t).Pn();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){let n=tI(e,tr),r=!0,i=new Map;return el.forEach(this.dn(t),t=>this.An(e,t).next(e=>{r&&(r=!!e),i.set(t,e)})).next(()=>{if(r){let e=n8(),r=[];return el.forEach(i,(i,s)=>{T(iK,`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${nV(t)}`);let a=function(e,t){let n=Z(t);if(void 0===n)return null;for(let t of nM(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let n=new Map;for(let r of J(t))for(let t of nM(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),l=function(e,t){let n=[],r=!0;for(let i of J(t)){let t=0===i.kind?nO(e,i.fieldPath,e.startAt):nF(e,i.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new nh(n,r)}(s,i),u=function(e,t){let n=[],r=!0;for(let i of J(t)){let t=0===i.kind?nF(e,i.fieldPath,e.endAt):nO(e,i.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new nh(n,r)}(s,i),h=this.Rn(i,s,l),c=this.Rn(i,s,u),d=this.Vn(i,s,o),f=this.mn(i.indexId,a,h,l.inclusive,c,u.inclusive,d);return el.forEach(f,i=>n.H(i,t.limit).next(t=>{t.forEach(t=>{let n=W.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return el.resolve(null)})}dn(e){let t=this.En.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(t instanceof ng||t instanceof np||x(),t instanceof ng)return t;if(1===t.filters.length)return e(t.filters[0]);let n=t.filters.map(t=>e(t)),r=np.create(n,t.op);return iP(r=iB(r))?r:(r instanceof np||x(),ny(r)||x(),r.filters.length>1||x(),r.filters.reduce((e,t)=>iU(e,t)))}(function e(t){var n,r;if(t instanceof ng||t instanceof np||x(),t instanceof ng){if(t instanceof nN){let e=(null===(r=null===(n=t.value.arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.map(e=>ng.create(t.field,"==",e)))||[];return np.create(e,"or")}return t}let i=t.filters.map(t=>e(t));return np.create(i,t.op)}(e));return iP(t)||x(),iO(t)||iF(t)?[t]:t.getFilters()})(np.create(e.filters,"and")).map(t=>nA(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.En.set(e,t)),t}mn(e,t,n,r,i,s,a){let o=(null!=t?t.length:1)*Math.max(n.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let h=0;h<o;++h){let o=t?this.fn(t[h/l]):iG,c=this.gn(e,o,n[h%l],r),d=this.pn(e,o,i[h%l],s),f=a.map(t=>this.gn(e,o,t,!0));u.push(...this.createRange(c,d,f))}return u}gn(e,t,n,r){let i=new iV(e,W.empty(),t,n);return r?i:i.nn()}pn(e,t,n,r){let i=new iV(e,W.empty(),t,n);return r?i.nn():i}An(e,t){let n=new iM(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(let r of e)n.un(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2,r=this.dn(t);return el.forEach(r,t=>this.An(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new tN(H.comparator),n=!1;for(let r of e.filters)for(let e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(let n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&r.length>1&&2===n?1:n)}yn(e,t){let n=new iA;for(let r of J(e)){let e=t.data.field(r.fieldPath);if(null==e)return null;let i=n.tn(r.kind);iS.xt.At(e,i)}return n.Yt()}fn(e){let t=new iA;return iS.xt.At(e,t.tn(0)),t.Yt()}wn(e,t){let n=new iA;return iS.xt.At(t8(this.databaseId,t),n.tn(function(e){let t=J(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Yt()}Vn(e,t,n){if(null===n)return[];let r=[];r.push(new iA);let i=0;for(let s of J(e)){let e=n[i++];for(let n of r)if(this.Sn(t,s.fieldPath)&&t9(e))r=this.bn(r,s,e);else{let t=n.tn(s.kind);iS.xt.At(e,t)}}return this.Dn(r)}Rn(e,t,n){return this.Vn(e,t,n.position)}Dn(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Yt();return t}bn(e,t,n){let r=[...e],i=[];for(let e of n.arrayValue.values||[])for(let n of r){let r=new iA;r.seed(n.Yt()),iS.xt.At(e,r.tn(t.kind)),i.push(r)}return i}Sn(e,t){return!!e.filters.find(e=>e instanceof ng&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let n=tI(e,e6),r=tI(e,e7);return(t?n.G(e9,IDBKeyRange.bound(t,t)):n.G()).next(e=>{let t=[];return el.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function(e,t){let n=t?new ee(t.sequenceNumber,new er(ig(t.readTime),new W(eC(t.documentKey)),t.largestBatchId)):ee.empty(),r=e.fields.map(([e,t])=>new X(H.fromServerFormat(e),t));return new Y(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:U(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){let r=tI(e,e6),i=tI(e,e7);return this.vn(e).next(e=>r.G(e9,IDBKeyRange.bound(t,t)).next(t=>el.forEach(t,t=>i.put(iE(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){let n=new Map;return el.forEach(t,(t,r)=>{let i=n.get(t.collectionGroup);return(i?el.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(n.set(t.collectionGroup,i),el.forEach(i,n=>this.Cn(e,t,n).next(t=>{let i=this.Fn(r,n);return t.isEqual(i)?el.resolve():this.Mn(e,r,n,t,i)}))))})}xn(e,t,n,r){return tI(e,tr).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.wn(n,t.key),documentKey:t.key.path.toArray()})}On(e,t,n,r){return tI(e,tr).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.wn(n,t.key),t.key.path.toArray()])}Cn(e,t,n){let r=tI(e,tr),i=new tN(iR);return r.Z({index:ts,range:IDBKeyRange.only([n.indexId,this.uid,this.wn(n,t)])},(e,r)=>{i=i.add(new iV(n.indexId,t,r.arrayValue,r.directionalValue))}).next(()=>i)}Fn(e,t){let n=new tN(iR),r=this.yn(t,e);if(null==r)return n;let i=Z(t);if(null!=i){let s=e.data.field(i.fieldPath);if(t9(s))for(let i of s.arrayValue.values||[])n=n.add(new iV(t.indexId,e.key,this.fn(i),r))}else n=n.add(new iV(t.indexId,e.key,iG,r));return n}Mn(e,t,n,r,i){T(iK,"Updating index entries for document '%s'",t.key);let s=[];return function(e,t,n,r,i){let s=e.getIterator(),a=t.getIterator(),o=tD(s),l=tD(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let r=n(o,l);r<0?t=!0:r>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(l),l=tD(a)):t?(i(o),o=tD(s)):(o=tD(s),l=tD(a))}}(r,i,iR,r=>{s.push(this.xn(e,t,n,r))},r=>{s.push(this.On(e,t,n,r))}),el.waitFor(s)}vn(e){let t=1;return tI(e,e7).Z({index:tt,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>iR(e,t)).filter((e,t,n)=>!t||0!==iR(e,n[t-1]));let r=[];for(let i of(r.push(e),n)){let n=iR(i,e),s=iR(i,t);if(0===n)r[0]=e.nn();else if(n>0&&s<0)r.push(i),r.push(i.nn());else if(s>0)break}r.push(t);let i=[];for(let e=0;e<r.length;e+=2){if(this.Nn(r[e],r[e+1]))return[];let t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,iG,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,iG,[]];i.push(IDBKeyRange.bound(t,n))}return i}Nn(e,t){return iR(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(iQ)}getMinOffset(e,t){return el.mapArray(this.dn(t),t=>this.An(e,t).next(e=>e||x())).next(iQ)}}function iQ(e){0!==e.length||x();let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){let i=e[r].indexState.offset;0>ei(i,t)&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new er(t.readTime,t.documentKey,n)}let iH={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class iW{static withCacheSize(e){return new iW(e,iW.DEFAULT_COLLECTION_PERCENTILE,iW.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}}function iY(e,t,n){let r=e.store(eR),i=e.store(eP),s=[],a=IDBKeyRange.only(n.batchId),o=0,l=r.Z({range:a},(e,t,n)=>(o++,n.delete()));s.push(l.next(()=>{1===o||x()}));let u=[];for(let e of n.mutations){var h,c;let r=(h=e.key.path,c=n.batchId,[t,eN(h),c]);s.push(i.delete(r)),u.push(e.key)}return el.waitFor(s).next(()=>u)}function iZ(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw x();t=e.noDocument}return JSON.stringify(t).length}iW.DEFAULT_COLLECTION_PERCENTILE=10,iW.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,iW.DEFAULT=new iW(0x2800000,iW.DEFAULT_COLLECTION_PERCENTILE,iW.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),iW.DISABLED=new iW(-1,0,0);class iJ{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Bn={}}static It(e,t,n,r){return""!==e.uid||x(),new iJ(e.isAuthenticated()?e.uid:"",t,n,r)}checkEmpty(e){let t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return i0(e).Z({index:eM,range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){let i=tI(e,eP),s=i0(e);return s.add({}).next(a=>{"number"==typeof a||x();let o=new rS(a,t,n,r),l=function(e,t,n){let r=n.baseMutations.map(t=>ie(e.Tt,t)),i=n.mutations.map(t=>ie(e.Tt,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:i}}(this.serializer,this.userId,o),u=[],h=new tN((e,t)=>U(e.canonicalString(),t.canonicalString()));for(let e of r){let t=[this.userId,eN(e.key.path),a];h=h.add(e.key.path.popLast()),u.push(s.put(l)),u.push(i.put(t,eF))}return h.forEach(t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Bn[a]=o.keys()}),el.waitFor(u).next(()=>o)})}lookupMutationBatch(e,t){return i0(e).get(t).next(e=>e?(e.userId===this.userId||x(),ip(this.serializer,e)):null)}Ln(e,t){return this.Bn[t]?el.resolve(this.Bn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let n=e.keys();return this.Bn[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){let n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]),i=null;return i0(e).Z({index:eM,range:r},(e,t,r)=>{t.userId===this.userId&&(t.batchId>=n||x(),i=ip(this.serializer,t)),r.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return i0(e).Z({index:eM,range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return i0(e).G(eM,t).next(e=>e.map(e=>ip(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let n=[this.userId,eN(t.path)],r=IDBKeyRange.lowerBound(n),i=[];return tI(e,eP).Z({range:r},(n,r,s)=>{let[a,o,l]=n,u=eC(o);if(a===this.userId&&t.path.isEqual(u))return i0(e).get(l).next(e=>{if(!e)throw x();e.userId===this.userId||x(),i.push(ip(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tN(U),r=[];return t.forEach(t=>{let i=[this.userId,eN(t.path)],s=IDBKeyRange.lowerBound(i),a=tI(e,eP).Z({range:s},(e,r,i)=>{let[s,a,o]=e,l=eC(a);s===this.userId&&t.path.isEqual(l)?n=n.add(o):i.done()});r.push(a)}),el.waitFor(r).next(()=>this.kn(e,n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=[this.userId,eN(n)],s=IDBKeyRange.lowerBound(i),a=new tN(U);return tI(e,eP).Z({range:s},(e,t,i)=>{let[s,o,l]=e,u=eC(o);s===this.userId&&n.isPrefixOf(u)?u.length===r&&(a=a.add(l)):i.done()}).next(()=>this.kn(e,a))}kn(e,t){let n=[],r=[];return t.forEach(t=>{r.push(i0(e).get(t).next(e=>{if(null===e)throw x();e.userId===this.userId||x(),n.push(ip(this.serializer,e))}))}),el.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return iY(e.ue,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.qn(t.batchId)}),el.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}qn(e){delete this.Bn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return el.resolve();let n=IDBKeyRange.lowerBound([this.userId]),r=[];return tI(e,eP).Z({range:n},(e,t,n)=>{if(e[0]===this.userId){let t=eC(e[1]);r.push(t)}else n.done()}).next(()=>{0===r.length||x()})})}containsKey(e,t){return iX(e,this.userId,t)}Qn(e){return tI(e,eV).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function iX(e,t,n){let r=[t,eN(n.path)],i=r[1],s=IDBKeyRange.lowerBound(r),a=!1;return tI(e,eP).Z({range:s,Y:!0},(e,n,r)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),r.done()}).next(()=>a)}function i0(e){return tI(e,eR)}class i1{constructor(e){this.$n=e}next(){return this.$n+=2,this.$n}static Un(){return new i1(0)}static Kn(){return new i1(-1)}}class i2{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.Wn(e).next(t=>{let n=new i1(t.highestTargetId);return t.highestTargetId=n.next(),this.Gn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Wn(e).next(e=>$.fromTimestamp(new z(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Wn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.Wn(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Gn(e,r)))}addTargetData(e,t){return this.zn(e,t).next(()=>this.Wn(e).next(n=>(n.targetCount+=1,this.jn(t,n),this.Gn(e,n))))}updateTargetData(e,t){return this.zn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>tI(e,eQ).delete(t.targetId)).next(()=>this.Wn(e)).next(t=>(t.targetCount>0||x(),t.targetCount-=1,this.Gn(e,t)))}removeTargets(e,t,n){let r=0,i=[];return tI(e,eQ).Z((s,a)=>{let o=iy(a);o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r++,i.push(this.removeTargetData(e,o)))}).next(()=>el.waitFor(i)).next(()=>r)}forEachTarget(e,t){return tI(e,eQ).Z((e,n)=>{t(iy(n))})}Wn(e){return tI(e,e1).get(e0).next(e=>(null!==e||x(),e))}Gn(e,t){return tI(e,e1).put(e0,t)}zn(e,t){return tI(e,eQ).put(iw(this.serializer,t))}jn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Wn(e).next(e=>e.targetCount)}getTargetData(e,t){let n=nV(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),i=null;return tI(e,eQ).Z({range:r,index:eH},(e,n,r)=>{let s=iy(n);nR(t,s.target)&&(i=s,r.done())}).next(()=>i)}addMatchingKeys(e,t,n){let r=[],i=i5(e);return t.forEach(t=>{let s=eN(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))}),el.waitFor(r)}removeMatchingKeys(e,t,n){let r=i5(e);return el.forEach(t,t=>{let i=eN(t.path);return el.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){let n=i5(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){let n=IDBKeyRange.bound([t],[t+1],!1,!0),r=i5(e),i=n8();return r.Z({range:n,Y:!0},(e,t,n)=>{let r=new W(eC(e[1]));i=i.add(r)}).next(()=>i)}containsKey(e,t){let n=eN(t.path),r=IDBKeyRange.bound([n],[n+"\0"],!1,!0),i=0;return i5(e).Z({index:eJ,Y:!0,range:r},([e,t],n,r)=>{0!==e&&(i++,r.done())}).next(()=>i>0)}lt(e,t){return tI(e,eQ).get(t).next(e=>e?iy(e):null)}}function i5(e){return tI(e,eY)}let i3="LruGarbageCollector";function i4([e,t],[n,r]){let i=U(e,n);return 0===i?U(t,r):i}class i8{constructor(e){this.Hn=e,this.buffer=new tN(i4),this.Jn=0}Yn(){return++this.Jn}Zn(e){let t=[e,this.Yn()];if(this.buffer.size<this.Hn)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>i4(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class i6{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Xn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.er(6e4)}stop(){this.Xn&&(this.Xn.cancel(),this.Xn=null)}get started(){return null!==this.Xn}er(e){T(i3,`Garbage collection scheduled in ${e}ms`),this.Xn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Xn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){eg(e)?T(i3,"Ignoring IndexedDB error during garbage collection: ",e):await eo(e)}await this.er(3e5)})}}class i9{constructor(e,t){this.tr=e,this.params=t}calculateTargetCount(e,t){return this.tr.nr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return el.resolve(e_.ae);let n=new i8(t);return this.tr.forEachTarget(e,e=>n.Zn(e.sequenceNumber)).next(()=>this.tr.rr(e,e=>n.Zn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.tr.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.tr.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector","Garbage collection skipped; disabled"),el.resolve(iH)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),iH):this.ir(e,t))}getCacheSize(e){return this.tr.getCacheSize(e)}ir(e,t){let n,r,i,s,a,o,l;let h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(T("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,s=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>(l=Date.now(),I()<=u.$b.DEBUG&&T("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-h}ms
	Determined least recently used ${r} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-h}ms`),el.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})))}}class i7{constructor(e,t){this.db=e,this.garbageCollector=new i9(this,t)}nr(e){let t=this.sr(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}sr(e){let t=0;return this.rr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}rr(e,t){return this._r(e,(e,n)=>t(n))}addReference(e,t,n){return se(e,n)}removeReference(e,t,n){return se(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return se(e,t)}ar(e,t){let n;return n=!1,tI(e,eV).X(r=>iX(e,r,t).next(e=>(e&&(n=!0),el.resolve(!e)))).next(()=>n)}removeOrphanedDocuments(e,t){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[],i=0;return this._r(e,(s,a)=>{if(a<=t){let t=this.ar(e,s).next(t=>{if(!t)return i++,n.getEntry(e,s).next(()=>(n.removeEntry(s,$.min()),i5(e).delete([0,eN(s.path)])))});r.push(t)}}).next(()=>el.waitFor(r)).next(()=>n.apply(e)).next(()=>i)}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return se(e,t)}_r(e,t){let n=i5(e),r,i=e_.ae;return n.Z({index:eJ},([e,n],{path:s,sequenceNumber:a})=>{0===e?(i!==e_.ae&&t(new W(eC(r)),i),i=a,r=s):i=e_.ae}).next(()=>{i!==e_.ae&&t(new W(eC(r)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function se(e,t){var n;return i5(e).put((n=e.currentSequenceNumber,{targetId:0,path:eN(t.path),sequenceNumber:n}))}class st{constructor(){this.changes=new nJ(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,nu.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let n=this.changes.get(t);return void 0!==n?el.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class sn{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return tI(e,eU).put(n)}removeEntry(e,t,n){return tI(e,eU).delete(function(e,t){let n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],id(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.ur(e,n)))}getEntry(e,t){let n=nu.newInvalidDocument(t);return tI(e,eU).Z({index:eB,range:IDBKeyRange.only(si(t))},(e,r)=>{n=this.cr(t,r)}).next(()=>n)}lr(e,t){let n={size:0,document:nu.newInvalidDocument(t)};return tI(e,eU).Z({index:eB,range:IDBKeyRange.only(si(t))},(e,r)=>{n={document:this.cr(t,r),size:iZ(r)}}).next(()=>n)}getEntries(e,t){let n=nX;return this.hr(e,t,(e,t)=>{let r=this.cr(e,t);n=n.insert(e,r)}).next(()=>n)}Pr(e,t){let n=nX,r=new tb(W.comparator);return this.hr(e,t,(e,t)=>{let i=this.cr(e,t);n=n.insert(e,i),r=r.insert(e,iZ(t))}).next(()=>({documents:n,Tr:r}))}hr(e,t,n){if(t.isEmpty())return el.resolve();let r=new tN(sa);t.forEach(e=>r=r.add(e));let i=IDBKeyRange.bound(si(r.first()),si(r.last())),s=r.getIterator(),a=s.getNext();return tI(e,eU).Z({index:eB,range:i},(e,t,r)=>{let i=W.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>sa(a,i);)n(a,null),a=s.getNext();a&&a.isEqual(i)&&(n(a,t),a=s.hasNext()?s.getNext():null),a?r.W(si(a)):r.done()}).next(()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),id(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tI(e,eU).G(IDBKeyRange.bound(a,o,!0)).next(e=>{null==i||i.incrementDocumentReadCount(e.length);let n=nX;for(let i of e){let e=this.cr(W.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(nW(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let i=nX,s=ss(t,n),a=ss(t,er.max());return tI(e,eU).Z({index:e$,range:IDBKeyRange.bound(s,a,!0)},(e,t,n)=>{let s=this.cr(W.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new sr(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return tI(e,eG).get(ej).next(e=>(e||x(),e))}ur(e,t){return tI(e,eG).put(ej,t)}cr(e,t){if(t){let e=function(e,t){let n;if(t.document)n=r7(e.Tt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=W.fromSegments(t.noDocument.path),r=ig(t.noDocument.readTime);n=nu.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return x();{let e=W.fromSegments(t.unknownDocument.path),r=ig(t.unknownDocument.version);n=nu.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){let t=new z(e[0],e[1]);return $.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual($.min())))return e}return nu.newInvalidDocument(e)}}class sr extends st{constructor(e,t){super(),this.Ir=e,this.trackRemovals=t,this.Er=new nJ(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],n=0,r=new tN((e,t)=>U(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.Er.get(i);if(t.push(this.Ir.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=ic(this.Ir.serializer,s);r=r.add(i.path.popLast());let l=iZ(o);n+=l-a.size,t.push(this.Ir.addEntry(e,i,o))}else if(n-=a.size,this.trackRemovals){let n=ic(this.Ir.serializer,s.convertToNoDocument($.min()));t.push(this.Ir.addEntry(e,i,n))}}),r.forEach(n=>{t.push(this.Ir.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.Ir.updateMetadata(e,n)),el.waitFor(t)}getFromCache(e,t){return this.Ir.lr(e,t).next(e=>(this.Er.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Ir.Pr(e,t).next(({documents:e,Tr:t})=>(t.forEach((t,n)=>{this.Er.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function si(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function ss(e,t){let n=t.documentKey.path.toArray();return[e,id(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function sa(e,t){let n=e.path.toArray(),r=t.path.toArray(),i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=U(n[e],r[e]))return i;return(i=U(n.length,r.length))||(i=U(n[n.length-2],r[r.length-2]))||U(n[n.length-1],r[r.length-1])}class so{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class sl{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&ry(n.mutation,e,tk.empty(),z.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,n8()).next(()=>t))}getLocalViewOfDocuments(e,t,n=n8()){let r=n5();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=n1();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let n=n5();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,n8()))}populateOverlays(e,t,n){let r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let i=nX,s=n5(),a=n5();return t.forEach((e,t)=>{let a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof rI)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),ry(a.mutation,t,a.mutation.getFieldMask(),z.now())):s.set(t.key,tk.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>{var n;return a.set(e,new so(t,null!==(n=s.get(e))&&void 0!==n?n:null))}),a))}recalculateAndSaveOverlays(e,t){let n=n5(),r=new tb((e,t)=>e-t),i=n8();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=n.get(e)||tk.empty();a=i.applyToLocalView(s,a),n.set(e,a);let o=(r.get(i.batchId)||n8()).add(e);r=r.insert(i.batchId,o)})}).next(()=>{let s=[],a=r.getReverseIterator();for(;a.hasNext();){let r=a.getNext(),o=r.key,l=r.value,u=n5();l.forEach(e=>{if(!i.has(e)){let r=rp(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return el.waitFor(s)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return W.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):nB(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(i=>{let s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):el.resolve(n5()),a=-1,o=i;return s.next(t=>el.forEach(t,(t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?el.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,n8())).next(e=>({batchId:a,changes:n2(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new W(t)).next(e=>{let t=n1();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){let i=t.collectionGroup,s=n1();return this.indexManager.getCollectionParents(e,i).next(a=>el.forEach(a,a=>{let o=new nP(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r))).next(e=>{i.forEach((t,n)=>{let r=n.getKey();null===e.get(r)&&(e=e.insert(r,nu.newInvalidDocument(r)))});let n=n1();return e.forEach((e,r)=>{let s=i.get(e);void 0!==s&&ry(s.mutation,r,tk.empty(),z.now()),nW(t,r)&&(n=n.insert(e,r))}),n})}}class su{constructor(e){this.serializer=e,this.dr=new Map,this.Ar=new Map}getBundleMetadata(e,t){return el.resolve(this.dr.get(t))}saveBundleMetadata(e,t){return this.dr.set(t.id,{id:t.id,version:t.version,createTime:rJ(t.createTime)}),el.resolve()}getNamedQuery(e,t){return el.resolve(this.Ar.get(t))}saveNamedQuery(e,t){return this.Ar.set(t.name,{name:t.name,query:iv(t.bundledQuery),readTime:rJ(t.readTime)}),el.resolve()}}class sh{constructor(){this.overlays=new tb(W.comparator),this.Rr=new Map}getOverlay(e,t){return el.resolve(this.overlays.get(t))}getOverlays(e,t){let n=n5();return el.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.Et(e,t,r)}),el.resolve()}removeOverlaysForBatchId(e,t,n){let r=this.Rr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Rr.delete(n)),el.resolve()}getOverlaysForCollection(e,t,n){let r=n5(),i=t.length+1,s=new W(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return el.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new tb((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=n5(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=n5(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return el.resolve(a)}Et(e,t,n){let r=this.overlays.get(n.key);if(null!==r){let e=this.Rr.get(r.largestBatchId).delete(n.key);this.Rr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new rC(t,n));let i=this.Rr.get(t);void 0===i&&(i=n8(),this.Rr.set(t,i)),this.Rr.set(t,i.add(n.key))}}class sc{constructor(){this.sessionToken=tV.EMPTY_BYTE_STRING}getSessionToken(e){return el.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,el.resolve()}}class sd{constructor(){this.Vr=new tN(sf.mr),this.gr=new tN(sf.pr)}isEmpty(){return this.Vr.isEmpty()}addReference(e,t){let n=new sf(e,t);this.Vr=this.Vr.add(n),this.gr=this.gr.add(n)}yr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.wr(new sf(e,t))}Sr(e,t){e.forEach(e=>this.removeReference(e,t))}br(e){let t=new W(new j([])),n=new sf(t,e),r=new sf(t,e+1),i=[];return this.gr.forEachInRange([n,r],e=>{this.wr(e),i.push(e.key)}),i}Dr(){this.Vr.forEach(e=>this.wr(e))}wr(e){this.Vr=this.Vr.delete(e),this.gr=this.gr.delete(e)}vr(e){let t=new W(new j([])),n=new sf(t,e),r=new sf(t,e+1),i=n8();return this.gr.forEachInRange([n,r],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new sf(e,0),n=this.Vr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class sf{constructor(e,t){this.key=e,this.Cr=t}static mr(e,t){return W.comparator(e.key,t.key)||U(e.Cr,t.Cr)}static pr(e,t){return U(e.Cr,t.Cr)||W.comparator(e.key,t.key)}}class sm{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Fr=1,this.Mr=new tN(sf.mr)}checkEmpty(e){return el.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){let i=this.Fr;this.Fr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new rS(i,t,n,r);for(let t of(this.mutationQueue.push(s),r))this.Mr=this.Mr.add(new sf(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return el.resolve(s)}lookupMutationBatch(e,t){return el.resolve(this.Or(t))}getNextMutationBatchAfterBatchId(e,t){let n=this.Nr(t+1),r=n<0?0:n;return el.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return el.resolve(0===this.mutationQueue.length?-1:this.Fr-1)}getAllMutationBatches(e){return el.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let n=new sf(t,0),r=new sf(t,Number.POSITIVE_INFINITY),i=[];return this.Mr.forEachInRange([n,r],e=>{let t=this.Or(e.Cr);i.push(t)}),el.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tN(U);return t.forEach(e=>{let t=new sf(e,0),r=new sf(e,Number.POSITIVE_INFINITY);this.Mr.forEachInRange([t,r],e=>{n=n.add(e.Cr)})}),el.resolve(this.Br(n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=n;W.isDocumentKey(i)||(i=i.child(""));let s=new sf(new W(i),0),a=new tN(U);return this.Mr.forEachWhile(e=>{let t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.Cr)),!0)},s),el.resolve(this.Br(a))}Br(e){let t=[];return e.forEach(e=>{let n=this.Or(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){0===this.Lr(t.batchId,"removed")||x(),this.mutationQueue.shift();let n=this.Mr;return el.forEach(t.mutations,r=>{let i=new sf(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.Mr=n})}qn(e){}containsKey(e,t){let n=new sf(t,0),r=this.Mr.firstAfterOrEqual(n);return el.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,el.resolve()}Lr(e,t){return this.Nr(e)}Nr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Or(e){let t=this.Nr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class sg{constructor(e){this.kr=e,this.docs=new tb(W.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.kr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let n=this.docs.get(t);return el.resolve(n?n.document.mutableCopy():nu.newInvalidDocument(t))}getEntries(e,t){let n=nX;return t.forEach(e=>{let t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():nu.newInvalidDocument(e))}),el.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=nX,s=t.path,a=new W(s.child("__id-9223372036854775808__")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=ei(en(a),n)||(r.has(a.key)||nW(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return el.resolve(i)}getAllFromCollectionGroup(e,t,n,r){x()}qr(e,t){return el.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new sp(this)}getSize(e){return el.resolve(this.size)}}class sp extends st{constructor(e){super(),this.Ir=e}applyChanges(e){let t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.Ir.addEntry(e,r)):this.Ir.removeEntry(n)}),el.waitFor(t)}getFromCache(e,t){return this.Ir.getEntry(e,t)}getAllFromCache(e,t){return this.Ir.getEntries(e,t)}}class sy{constructor(e){this.persistence=e,this.Qr=new nJ(e=>nV(e),nR),this.lastRemoteSnapshotVersion=$.min(),this.highestTargetId=0,this.$r=0,this.Ur=new sd,this.targetCount=0,this.Kr=i1.Un()}forEachTarget(e,t){return this.Qr.forEach((e,n)=>t(n)),el.resolve()}getLastRemoteSnapshotVersion(e){return el.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return el.resolve(this.$r)}allocateTargetId(e){return this.highestTargetId=this.Kr.next(),el.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.$r&&(this.$r=t),el.resolve()}zn(e){this.Qr.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.Kr=new i1(t),this.highestTargetId=t),e.sequenceNumber>this.$r&&(this.$r=e.sequenceNumber)}addTargetData(e,t){return this.zn(t),this.targetCount+=1,el.resolve()}updateTargetData(e,t){return this.zn(t),el.resolve()}removeTargetData(e,t){return this.Qr.delete(t.target),this.Ur.br(t.targetId),this.targetCount-=1,el.resolve()}removeTargets(e,t,n){let r=0,i=[];return this.Qr.forEach((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.Qr.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)}),el.waitFor(i).next(()=>r)}getTargetCount(e){return el.resolve(this.targetCount)}getTargetData(e,t){let n=this.Qr.get(t)||null;return el.resolve(n)}addMatchingKeys(e,t,n){return this.Ur.yr(t,n),el.resolve()}removeMatchingKeys(e,t,n){this.Ur.Sr(t,n);let r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(t=>{i.push(r.markPotentiallyOrphaned(e,t))}),el.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Ur.br(t),el.resolve()}getMatchingKeysForTargetId(e,t){let n=this.Ur.vr(t);return el.resolve(n)}containsKey(e,t){return el.resolve(this.Ur.containsKey(t))}}class sw{constructor(e,t){this.Wr={},this.overlays={},this.Gr=new e_(0),this.zr=!1,this.zr=!0,this.jr=new sc,this.referenceDelegate=e(this),this.Hr=new sy(this),this.indexManager=new iz,this.remoteDocumentCache=new sg(e=>this.referenceDelegate.Jr(e)),this.serializer=new ih(t),this.Yr=new su(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.zr=!1,Promise.resolve()}get started(){return this.zr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new sh,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Wr[e.toKey()];return n||(n=new sm(t,this.referenceDelegate),this.Wr[e.toKey()]=n),n}getGlobalsCache(){return this.jr}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Yr}runTransaction(e,t,n){T("MemoryPersistence","Starting transaction:",e);let r=new sv(this.Gr.next());return this.referenceDelegate.Zr(),n(r).next(e=>this.referenceDelegate.Xr(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}ei(e,t){return el.or(Object.values(this.Wr).map(n=>()=>n.containsKey(e,t)))}}class sv extends ea{constructor(e){super(),this.currentSequenceNumber=e}}class sI{constructor(e){this.persistence=e,this.ti=new sd,this.ni=null}static ri(e){return new sI(e)}get ii(){if(this.ni)return this.ni;throw x()}addReference(e,t,n){return this.ti.addReference(n,t),this.ii.delete(n.toString()),el.resolve()}removeReference(e,t,n){return this.ti.removeReference(n,t),this.ii.add(n.toString()),el.resolve()}markPotentiallyOrphaned(e,t){return this.ii.add(t.toString()),el.resolve()}removeTarget(e,t){this.ti.br(t.targetId).forEach(e=>this.ii.add(e.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.ii.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Zr(){this.ni=new Set}Xr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return el.forEach(this.ii,n=>{let r=W.fromPath(n);return this.si(e,r).next(e=>{e||t.removeEntry(r,$.min())})}).next(()=>(this.ni=null,t.apply(e)))}updateLimboDocument(e,t){return this.si(e,t).next(e=>{e?this.ii.delete(t.toString()):this.ii.add(t.toString())})}Jr(e){return 0}si(e,t){return el.or([()=>el.resolve(this.ti.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.ei(e,t)])}}class sT{constructor(e,t){this.persistence=e,this.oi=new nJ(e=>eN(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new i9(this,t)}static ri(e,t){return new sT(e,t)}Zr(){}Xr(e){return el.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}nr(e){let t=this.sr(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}sr(e){let t=0;return this.rr(e,e=>{t++}).next(()=>t)}rr(e,t){return el.forEach(this.oi,(n,r)=>this.ar(e,n,r).next(e=>e?el.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0,r=this.persistence.getRemoteDocumentCache(),i=r.newChangeBuffer();return r.qr(e,r=>this.ar(e,r,t).next(e=>{e||(n++,i.removeEntry(r,$.min()))})).next(()=>i.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.oi.set(t,e.currentSequenceNumber),el.resolve()}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.oi.set(n,e.currentSequenceNumber),el.resolve()}removeReference(e,t,n){return this.oi.set(n,e.currentSequenceNumber),el.resolve()}updateLimboDocument(e,t){return this.oi.set(t,e.currentSequenceNumber),el.resolve()}Jr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(tX(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let n=tz(t);return n?16+e(n):16;case 5:return 2*t.stringValue.length;case 6:return tO(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,n)=>t+e(n),0);case 10:case 11:var r;let i;return r=t.mapValue,i=0,tE(r.fields,(t,n)=>{i+=t.length+e(n)}),i;default:throw x()}}(e.data.value)),t}ar(e,t,n){return el.or([()=>this.persistence.ei(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.oi.get(t);return el.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class sE{constructor(e){this.serializer=e}B(e,t,n,r){let i=new eh("createOrUpgrade",t);n<1&&r>=1&&(!function(e){e.createObjectStore(ek)}(e),e.createObjectStore(eV,{keyPath:"userId"}),e.createObjectStore(eR,{keyPath:eL,autoIncrement:!0}).createIndex(eM,eO,{unique:!0}),e.createObjectStore(eP),s_(e),function(e){e.createObjectStore(eD)}(e));let s=el.resolve();return n<3&&r>=3&&(0!==n&&(e.deleteObjectStore(eY),e.deleteObjectStore(eQ),e.deleteObjectStore(e1),s_(e)),s=s.next(()=>(function(e){let t=e.store(e1),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:$.min().toTimestamp(),targetCount:0};return t.put(e0,n)})(i))),n<4&&r>=4&&(0!==n&&(s=s.next(()=>i.store(eR).G().next(t=>{e.deleteObjectStore(eR),e.createObjectStore(eR,{keyPath:eL,autoIncrement:!0}).createIndex(eM,eO,{unique:!0});let n=i.store(eR),r=t.map(e=>n.put(e));return el.waitFor(r)}))),s=s.next(()=>{!function(e){e.createObjectStore(e3,{keyPath:"clientId"})}(e)})),n<5&&r>=5&&(s=s.next(()=>this._i(i))),n<6&&r>=6&&(s=s.next(()=>((function(e){e.createObjectStore(eG)})(e),this.ai(i)))),n<7&&r>=7&&(s=s.next(()=>this.ui(i))),n<8&&r>=8&&(s=s.next(()=>this.ci(e,i))),n<9&&r>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&r>=10&&(s=s.next(()=>this.li(i))),n<11&&r>=11&&(s=s.next(()=>{(function(e){e.createObjectStore(e4,{keyPath:"bundleId"})})(e),function(e){e.createObjectStore(e8,{keyPath:"name"})}(e)})),n<12&&r>=12&&(s=s.next(()=>{!function(e){let t=e.createObjectStore(to,{keyPath:tl});t.createIndex(tu,th,{unique:!1}),t.createIndex(tc,td,{unique:!1})}(e)})),n<13&&r>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore(eU,{keyPath:eq});t.createIndex(eB,ez),t.createIndex(e$,eK)})(e)).next(()=>this.hi(e,i)).next(()=>e.deleteObjectStore(eD))),n<14&&r>=14&&(s=s.next(()=>this.Pi(e,i))),n<15&&r>=15&&(s=s.next(()=>{e.createObjectStore(e6,{keyPath:"indexId",autoIncrement:!0}).createIndex(e9,"collectionGroup",{unique:!1}),e.createObjectStore(e7,{keyPath:te}).createIndex(tt,tn,{unique:!1}),e.createObjectStore(tr,{keyPath:ti}).createIndex(ts,ta,{unique:!1})})),n<16&&r>=16&&(s=s.next(()=>{t.objectStore(e7).clear()}).next(()=>{t.objectStore(tr).clear()})),n<17&&r>=17&&(s=s.next(()=>{!function(e){e.createObjectStore(tf,{keyPath:"name"})}(e)})),s}ai(e){let t=0;return e.store(eD).Z((e,n)=>{t+=iZ(n)}).next(()=>{let n={byteSize:t};return e.store(eG).put(ej,n)})}_i(e){let t=e.store(eV),n=e.store(eR);return t.G().next(t=>el.forEach(t,t=>{let r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.G(eM,r).next(n=>el.forEach(n,n=>{n.userId===t.userId||x();let r=ip(this.serializer,n);return iY(e,t.userId,r).next(()=>{})}))}))}ui(e){let t=e.store(eY),n=e.store(eD);return e.store(e1).get(e0).next(e=>{let r=[];return n.Z((n,i)=>{let s=new j(n),a=[0,eN(s)];r.push(t.get(a).next(n=>n?el.resolve():t.put({targetId:0,path:eN(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>el.waitFor(r))})}ci(e,t){e.createObjectStore(e2,{keyPath:e5});let n=t.store(e2),r=new i$,i=e=>{if(r.add(e)){let t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:eN(r)})}};return t.store(eD).Z({Y:!0},(e,t)=>i(new j(e).popLast())).next(()=>t.store(eP).Z({Y:!0},([e,t,n],r)=>i(eC(t).popLast())))}li(e){let t=e.store(eQ);return t.Z((e,n)=>{let r=iy(n),i=iw(this.serializer,r);return t.put(i)})}hi(e,t){let n=t.store(eD),r=[];return n.Z((e,n)=>{let i=t.store(eU),s=(n.document?new W(j.fromString(n.document.name).popFirst(5)):n.noDocument?W.fromSegments(n.noDocument.path):n.unknownDocument?W.fromSegments(n.unknownDocument.path):x()).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(a))}).next(()=>el.waitFor(r))}Pi(e,t){let n=t.store(eR),r=new sn(this.serializer),i=new sw(sI.ri,this.serializer.Tt);return n.G().next(e=>{let n=new Map;return e.forEach(e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:n8();ip(this.serializer,e).keys().forEach(e=>r=r.add(e)),n.set(e.userId,r)}),el.forEach(n,(e,n)=>{let s=new y(n),a=ib.It(this.serializer,s),o=i.getIndexManager(s);return new sl(r,iJ.It(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new tv(t,e_.ae),e).next()})})}}function s_(e){e.createObjectStore(eY,{keyPath:eZ}).createIndex(eJ,eX,{unique:!0}),e.createObjectStore(eQ,{keyPath:"targetId"}).createIndex(eH,eW,{unique:!0}),e.createObjectStore(e1)}let sb="IndexedDbPersistence",sx="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class sS{constructor(e,t,n,r,i,s,a,o,l,u,h=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Ti=i,this.window=s,this.document=a,this.Ii=l,this.Ei=u,this.di=h,this.Gr=null,this.zr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ai=null,this.inForeground=!1,this.Ri=null,this.Vi=null,this.mi=Number.NEGATIVE_INFINITY,this.fi=e=>Promise.resolve(),!sS.D())throw new N(S.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new i7(this,r),this.gi=t+"main",this.serializer=new ih(o),this.pi=new ec(this.gi,this.di,new sE(this.serializer)),this.jr=new ix,this.Hr=new i2(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new sn(this.serializer),this.Yr=new i_,this.window&&this.window.localStorage?this.yi=this.window.localStorage:(this.yi=null,!1===u&&E(sb,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.wi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new N(S.FAILED_PRECONDITION,sx);return this.Si(),this.bi(),this.Di(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Hr.getHighestSequenceNumber(e))}).then(e=>{this.Gr=new e_(e,this.Ii)}).then(()=>{this.zr=!0}).catch(e=>(this.pi&&this.pi.close(),Promise.reject(e)))}Ci(e){return this.fi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.pi.k(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Ti.enqueueAndForget(async()=>{this.started&&await this.wi()}))}wi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>tI(e,e3).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Fi(e).next(e=>{e||(this.isPrimary=!1,this.Ti.enqueueRetryable(()=>this.fi(!1)))})}).next(()=>this.Mi(e)).next(t=>this.isPrimary&&!t?this.xi(e).next(()=>!1):!!t&&this.Oi(e).next(()=>!0))).catch(e=>{if(eg(e))return T(sb,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return T(sb,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Ti.enqueueRetryable(()=>this.fi(e)),this.isPrimary=e})}Fi(e){return tI(e,ek).get(eA).next(e=>el.resolve(this.Ni(e)))}Bi(e){return tI(e,e3).delete(this.clientId)}async Li(){if(this.isPrimary&&!this.ki(this.mi,18e5)){this.mi=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=tI(e,e3);return t.G().next(e=>{let n=this.qi(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return el.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.yi)for(let t of e)this.yi.removeItem(this.Qi(t.clientId))}}Di(){this.Vi=this.Ti.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.wi().then(()=>this.Li()).then(()=>this.Di()))}Ni(e){return!!e&&e.ownerId===this.clientId}Mi(e){return this.Ei?el.resolve(!0):tI(e,ek).get(eA).next(t=>{if(null!==t&&this.ki(t.leaseTimestampMs,5e3)&&!this.$i(t.ownerId)){if(this.Ni(t)&&this.networkEnabled)return!0;if(!this.Ni(t)){if(!t.allowTabSynchronization)throw new N(S.FAILED_PRECONDITION,sx);return!1}}return!(!this.networkEnabled||!this.inForeground)||tI(e,e3).G().next(e=>void 0===this.qi(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&T(sb,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.zr=!1,this.Ui(),this.Vi&&(this.Vi.cancel(),this.Vi=null),this.Ki(),this.Wi(),await this.pi.runTransaction("shutdown","readwrite",[ek,e3],e=>{let t=new tv(e,e_.ae);return this.xi(t).next(()=>this.Bi(t))}),this.pi.close(),this.Gi()}qi(e,t){return e.filter(e=>this.ki(e.updateTimeMs,t)&&!this.$i(e.clientId))}zi(){return this.runTransaction("getActiveClients","readonly",e=>tI(e,e3).G().next(e=>this.qi(e,18e5).map(e=>e.clientId)))}get started(){return this.zr}getGlobalsCache(){return this.jr}getMutationQueue(e,t){return iJ.It(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new ij(e,this.serializer.Tt.databaseId)}getDocumentOverlayCache(e){return ib.It(this.serializer,e)}getBundleCache(){return this.Yr}runTransaction(e,t,n){var r;let i;T(sb,"Starting transaction:",e);let s=17===(r=this.di)?tw:16===r?ty:15===r?ty:14===r?tp:13===r?tp:12===r?tg:11===r?tm:void x();return this.pi.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,r=>(i=new tv(r,this.Gr?this.Gr.next():e_.ae),"readwrite-primary"===t?this.Fi(i).next(e=>!!e||this.Mi(i)).next(t=>{if(!t)throw E(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Ti.enqueueRetryable(()=>this.fi(!1)),new N(S.FAILED_PRECONDITION,es);return n(i)}).next(e=>this.Oi(i).next(()=>e)):this.ji(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}ji(e){return tI(e,ek).get(eA).next(e=>{if(null!==e&&this.ki(e.leaseTimestampMs,5e3)&&!this.$i(e.ownerId)&&!this.Ni(e)&&!(this.Ei||this.allowTabSynchronization&&e.allowTabSynchronization))throw new N(S.FAILED_PRECONDITION,sx)})}Oi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tI(e,ek).put(eA,t)}static D(){return ec.D()}xi(e){let t=tI(e,ek);return t.get(eA).next(e=>this.Ni(e)?(T(sb,"Releasing primary lease."),t.delete(eA)):el.resolve())}ki(e,t){let n=Date.now();return!(e<n-t)&&(!(e>n)||(E(`Detected an update time that is in the future: ${e} > ${n}`),!1))}Si(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ri=()=>{this.Ti.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.wi()))},this.document.addEventListener("visibilitychange",this.Ri),this.inForeground="visible"===this.document.visibilityState)}Ki(){this.Ri&&(this.document.removeEventListener("visibilitychange",this.Ri),this.Ri=null)}bi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Ai=()=>{this.Ui();let e=/(?:Version|Mobile)\/1[456]/;(0,h.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Ti.enterRestrictedMode(!0),this.Ti.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Ai))}Wi(){this.Ai&&(this.window.removeEventListener("pagehide",this.Ai),this.Ai=null)}$i(e){var t;try{let n=null!==(null===(t=this.yi)||void 0===t?void 0:t.getItem(this.Qi(e)));return T(sb,`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return E(sb,"Failed to get zombied client id.",e),!1}}Ui(){if(this.yi)try{this.yi.setItem(this.Qi(this.clientId),String(Date.now()))}catch(e){E("Failed to set zombie client id.",e)}}Gi(){if(this.yi)try{this.yi.removeItem(this.Qi(this.clientId))}catch(e){}}Qi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function sN(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class sC{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Hi=n,this.Ji=r}static Yi(e,t){let n=n8(),r=n8();for(let e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new sC(e,t.fromCache,n,r)}}class sD{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class sk{constructor(){this.Zi=!1,this.Xi=!1,this.es=100,this.ts=(0,h.nr)()?8:ed((0,h.ZQ)())>0?6:4}initialize(e,t){this.ns=e,this.indexManager=t,this.Zi=!0}getDocumentsMatchingQuery(e,t,n,r){let i={result:null};return this.rs(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ss(e,t,r,n).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let n=new sD;return this._s(e,t,n).next(r=>{if(i.result=r,this.Xi)return this.us(e,t,n,r.size)})}).next(()=>i.result)}us(e,t,n,r){return n.documentReadCount<this.es?(I()<=u.$b.DEBUG&&T("QueryEngine","SDK will not create cache indexes for query:",nH(t),"since it only creates cache indexes for collection contains","more than or equal to",this.es,"documents"),el.resolve()):(I()<=u.$b.DEBUG&&T("QueryEngine","Query:",nH(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.ts*r?(I()<=u.$b.DEBUG&&T("QueryEngine","The SDK decides to create cache indexes for query:",nH(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,n$(t))):el.resolve())}rs(e,t){if(nq(t))return el.resolve(null);let n=n$(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(n=n$(t=nG(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{let i=n8(...r);return this.ns.getDocuments(e,i).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{let s=this.cs(t,r);return this.ls(t,s,i,n.readTime)?this.rs(e,nG(t,null,"F")):this.hs(e,s,t,n)}))})))}ss(e,t,n,r){return nq(t)||r.isEqual($.min())?el.resolve(null):this.ns.getDocuments(e,n).next(i=>{let s=this.cs(t,i);return this.ls(t,s,n,r)?el.resolve(null):(I()<=u.$b.DEBUG&&T("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),nH(t)),this.hs(e,s,t,et(r,-1)).next(e=>e))})}cs(e,t){let n=new tN(nZ(e));return t.forEach((t,r)=>{nW(e,r)&&(n=n.add(r))}),n}ls(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}_s(e,t,n){return I()<=u.$b.DEBUG&&T("QueryEngine","Using full collection scan to execute query:",nH(t)),this.ns.getDocumentsMatchingQuery(e,t,er.min(),n)}hs(e,t,n,r){return this.ns.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}let sA="LocalStore";class sV{constructor(e,t,n,r){this.persistence=e,this.Ps=t,this.serializer=r,this.Ts=new tb(U),this.Is=new nJ(e=>nV(e),nR),this.Es=new Map,this.ds=e.getRemoteDocumentCache(),this.Hr=e.getTargetCache(),this.Yr=e.getBundleCache(),this.As(n)}As(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new sl(this.ds,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ds.setIndexManager(this.indexManager),this.Ps.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ts))}}async function sR(e,t){return await e.persistence.runTransaction("Handle user change","readonly",n=>{let r;return e.mutationQueue.getAllMutationBatches(n).next(i=>(r=i,e.As(t),e.mutationQueue.getAllMutationBatches(n))).next(t=>{let i=[],s=[],a=n8();for(let e of r)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(n,a).next(e=>({Rs:e,removedBatchIds:i,addedBatchIds:s}))})})}function sL(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Hr.getLastRemoteSnapshotVersion(t))}function sM(e,t,n){let r=n8(),i=n8();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=nX;return n.forEach((n,s)=>{let a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual($.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):T(sA,"Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)}),{Vs:r,fs:i}})}function sO(e,t){return e.persistence.runTransaction("Allocate target","readwrite",n=>{let r;return e.Hr.getTargetData(n,t).next(i=>i?(r=i,el.resolve(r)):e.Hr.allocateTargetId(n).next(i=>(r=new iu(t,i,"TargetPurposeListen",n.currentSequenceNumber),e.Hr.addTargetData(n,r).next(()=>r))))}).then(n=>{let r=e.Ts.get(n.targetId);return(null===r||n.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(e.Ts=e.Ts.insert(n.targetId,n),e.Is.set(t,n.targetId)),n})}async function sF(e,t,n){let r=e.Ts.get(t);try{n||await e.persistence.runTransaction("Release target",n?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,r))}catch(e){if(!eg(e))throw e;T(sA,`Failed to update sequence numbers for target ${t}: ${e}`)}e.Ts=e.Ts.remove(t),e.Is.delete(r.target)}function sP(e,t,n){let r=$.min(),i=n8();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,n){let r=e.Is.get(n);return void 0!==r?el.resolve(e.Ts.get(r)):e.Hr.getTargetData(t,n)})(e,s,n$(t)).next(t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,e.Hr.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.Ps.getDocumentsMatchingQuery(s,t,n?r:$.min(),n?i:n8())).next(n=>(sB(e,nY(t),n),{documents:n,gs:i})))}function sU(e,t){let n=e.Hr,r=e.Ts.get(t);return r?Promise.resolve(r.target):e.persistence.runTransaction("Get target data","readonly",e=>n.lt(e,t).next(e=>e?e.target:null))}function sq(e,t){let n=e.Es.get(t)||$.min();return e.persistence.runTransaction("Get new document changes","readonly",r=>e.ds.getAllFromCollectionGroup(r,t,et(n,-1),Number.MAX_SAFE_INTEGER)).then(n=>(sB(e,t,n),n))}function sB(e,t,n){let r=e.Es.get(t)||$.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.Es.set(t,r)}let sz="firestore_clients";function s$(e,t){return`${sz}_${e}_${t}`}let sK="firestore_mutations";function sG(e,t,n){let r=`${sK}_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}let sj="firestore_targets";function sQ(e,t){return`${sj}_${e}_${t}`}let sH="SharedClientState";class sW{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ss(e,t,n){let r=JSON.parse(n),i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new N(r.error.code,r.error.message)),s?new sW(e,t,r.state,i):(E(sH,`Failed to parse mutation state for ID '${t}': ${n}`),null)}bs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class sY{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ss(e,t){let n=JSON.parse(t),r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new N(n.error.code,n.error.message)),i?new sY(e,n.state,r):(E(sH,`Failed to parse target state for ID '${e}': ${t}`),null)}bs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class sZ{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ss(e,t){let n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=n6;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=eS(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new sZ(e,i):(E(sH,`Failed to parse client data for instance '${e}': ${t}`),null)}}class sJ{constructor(e,t){this.clientId=e,this.onlineState=t}static Ss(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new sJ(t.clientId,t.onlineState):(E(sH,`Failed to parse online state: ${e}`),null)}}class sX{constructor(){this.activeTargetIds=n6}Ds(e){this.activeTargetIds=this.activeTargetIds.add(e)}vs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}bs(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class s0{constructor(e,t,n,r,i){var s,a,o;this.window=e,this.Ti=t,this.persistenceKey=n,this.Cs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Fs=this.Ms.bind(this),this.xs=new tb(U),this.started=!1,this.Os=[];let l=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Ns=s$(this.persistenceKey,this.Cs),this.Bs=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.xs=this.xs.insert(this.Cs,new sX),this.Ls=RegExp(`^${sz}_${l}_([^_]*)$`),this.ks=RegExp(`^${sK}_${l}_(\\d+)(?:_(.*))?$`),this.qs=RegExp(`^${sj}_${l}_(\\d+)$`),this.Qs=(a=this.persistenceKey,`firestore_online_state_${a}`),this.$s=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.Fs)}static D(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.zi())){if(e===this.Cs)continue;let t=this.getItem(s$(this.persistenceKey,e));if(t){let n=sZ.Ss(e,t);n&&(this.xs=this.xs.insert(n.clientId,n))}}this.Us();let e=this.storage.getItem(this.Qs);if(e){let t=this.Ks(e);t&&this.Ws(t)}for(let e of this.Os)this.Ms(e);this.Os=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.Bs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Gs(this.xs)}isActiveQueryTarget(e){let t=!1;return this.xs.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.zs(e,"pending")}updateMutationState(e,t,n){this.zs(e,t,n),this.js(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(sQ(this.persistenceKey,e));if(t){let r=sY.Ss(e,t);r&&(n=r.state)}}return t&&this.Hs.Ds(e),this.Us(),n}removeLocalQueryTarget(e){this.Hs.vs(e),this.Us()}isLocalQueryTarget(e){return this.Hs.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(sQ(this.persistenceKey,e))}updateQueryState(e,t,n){this.Js(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.js(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Ys(e)}notifyBundleLoaded(e){this.Zs(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Fs),this.removeItem(this.Ns),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return T(sH,"READ",e,t),t}setItem(e,t){T(sH,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){T(sH,"REMOVE",e),this.storage.removeItem(e)}Ms(e){if(e.storageArea===this.storage){if(T(sH,"EVENT",e.key,e.newValue),e.key===this.Ns)return void E("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Ti.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.Ls.test(e.key)){if(null==e.newValue){let t=this.Xs(e.key);return this.eo(t,null)}{let t=this.no(e.key,e.newValue);if(t)return this.eo(t.clientId,t)}}else if(this.ks.test(e.key)){if(null!==e.newValue){let t=this.ro(e.key,e.newValue);if(t)return this.io(t)}}else if(this.qs.test(e.key)){if(null!==e.newValue){let t=this.so(e.key,e.newValue);if(t)return this.oo(t)}}else if(e.key===this.Qs){if(null!==e.newValue){let t=this.Ks(e.newValue);if(t)return this.Ws(t)}}else if(e.key===this.Bs){let t=function(e){let t=e_.ae;if(null!=e)try{let n=JSON.parse(e);"number"==typeof n||x(),t=n}catch(e){E(sH,"Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==e_.ae&&this.sequenceNumberHandler(t)}else if(e.key===this.$s){let t=this._o(e.newValue);await Promise.all(t.map(e=>this.syncEngine.ao(e)))}}}else this.Os.push(e)})}}get Hs(){return this.xs.get(this.Cs)}Us(){this.setItem(this.Ns,this.Hs.bs())}zs(e,t,n){let r=new sW(this.currentUser,e,t,n),i=sG(this.persistenceKey,this.currentUser,e);this.setItem(i,r.bs())}js(e){let t=sG(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Ys(e){let t={clientId:this.Cs,onlineState:e};this.storage.setItem(this.Qs,JSON.stringify(t))}Js(e,t,n){let r=sQ(this.persistenceKey,e),i=new sY(e,t,n);this.setItem(r,i.bs())}Zs(e){let t=JSON.stringify(Array.from(e));this.setItem(this.$s,t)}Xs(e){let t=this.Ls.exec(e);return t?t[1]:null}no(e,t){let n=this.Xs(e);return sZ.Ss(n,t)}ro(e,t){let n=this.ks.exec(e),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return sW.Ss(new y(i),r,t)}so(e,t){let n=Number(this.qs.exec(e)[1]);return sY.Ss(n,t)}Ks(e){return sJ.Ss(e)}_o(e){return JSON.parse(e)}async io(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.uo(e.batchId,e.state,e.error);T(sH,`Ignoring mutation for non-active user ${e.user.uid}`)}oo(e){return this.syncEngine.co(e.targetId,e.state,e.error)}eo(e,t){let n=t?this.xs.insert(e,t):this.xs.remove(e),r=this.Gs(this.xs),i=this.Gs(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.lo(s,a).then(()=>{this.xs=n})}Ws(e){this.xs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Gs(e){let t=n6;return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class s1{constructor(){this.ho=new sX,this.Po={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.ho.Ds(e),this.Po[e]||"not-current"}updateQueryState(e,t,n){this.Po[e]=t}removeLocalQueryTarget(e){this.ho.vs(e)}isLocalQueryTarget(e){return this.ho.activeTargetIds.has(e)}clearQueryState(e){delete this.Po[e]}getAllActiveQueryTargets(){return this.ho.activeTargetIds}isActiveQueryTarget(e){return this.ho.activeTargetIds.has(e)}start(){return this.ho=new sX,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class s2{To(e){}shutdown(){}}let s5="ConnectivityMonitor";class s3{constructor(){this.Io=()=>this.Eo(),this.Ao=()=>this.Ro(),this.Vo=[],this.mo()}To(e){this.Vo.push(e)}shutdown(){window.removeEventListener("online",this.Io),window.removeEventListener("offline",this.Ao)}mo(){window.addEventListener("online",this.Io),window.addEventListener("offline",this.Ao)}Eo(){for(let e of(T(s5,"Network connectivity changed: AVAILABLE"),this.Vo))e(0)}Ro(){for(let e of(T(s5,"Network connectivity changed: UNAVAILABLE"),this.Vo))e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let s4=null;function s8(){return null===s4?s4=0x10000000+Math.round(0x80000000*Math.random()):s4++,"0x"+s4.toString(16)}let s6="RestConnection",s9={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class s7{get fo(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.po=t+"://"+e.host,this.yo=`projects/${n}/databases/${r}`,this.wo=this.databaseId.database===tG?`project_id=${n}`:`project_id=${n}&database_id=${r}`}So(e,t,n,r,i){let s=s8(),a=this.bo(e,t.toUriEncodedString());T(s6,`Sending RPC '${e}' ${s}:`,a,n);let o={"google-cloud-resource-prefix":this.yo,"x-goog-request-params":this.wo};return this.Do(o,r,i),this.vo(e,a,o,n).then(t=>(T(s6,`Received RPC '${e}' ${s}: `,t),t),t=>{throw _(s6,`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t})}Co(e,t,n,r,i,s){return this.So(e,t,n,r,i)}Do(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+w,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}bo(e,t){let n=s9[e];return`${this.po}/v1/${t}:${n}`}terminate(){}}class ae{constructor(e){this.Fo=e.Fo,this.Mo=e.Mo}xo(e){this.Oo=e}No(e){this.Bo=e}Lo(e){this.ko=e}onMessage(e){this.qo=e}close(){this.Mo()}send(e){this.Fo(e)}Qo(){this.Oo()}$o(){this.Bo()}Uo(e){this.ko(e)}Ko(e){this.qo(e)}}let at="WebChannelConnection";class an extends s7{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}vo(e,t,n,r){let i=s8();return new Promise((s,a)=>{let o=new d.ZS;o.setWithCredentials(!0),o.listenOnce(d.Bx.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case d.O4.NO_ERROR:let t=o.getResponseJson();T(at,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case d.O4.TIMEOUT:T(at,`RPC '${e}' ${i} timed out`),a(new N(S.DEADLINE_EXCEEDED,"Request time out"));break;case d.O4.HTTP_ERROR:let n=o.getStatus();if(T(at,`RPC '${e}' ${i} failed with status:`,n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=null==e?void 0:e.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(S).indexOf(t)>=0?t:S.UNKNOWN}(t.status);a(new N(e,t.message))}else a(new N(S.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new N(S.UNAVAILABLE,"Connection failed."));break;default:x()}}finally{T(at,`RPC '${e}' ${i} completed.`)}});let l=JSON.stringify(r);T(at,`RPC '${e}' ${i} sending request:`,r),o.send(t,"POST",l,n,15)})}Wo(e,t,n){let i=s8(),s=[this.po,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=(0,d.fF)(),o=(0,d.Ao)(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.Do(l.initMessageHeaders,t,n),l.encodeInitMessageHeaders=!0;let h=s.join("");T(at,`Creating RPC '${e}' stream ${i}: ${h}`,l);let c=a.createWebChannel(h,l),f=!1,m=!1,g=new ae({Fo:t=>{m?T(at,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(f||(T(at,`Opening RPC '${e}' stream ${i} transport.`),c.open(),f=!0),T(at,`RPC '${e}' stream ${i} sending:`,t),c.send(t))},Mo:()=>c.close()}),p=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return p(c,d.iO.EventType.OPEN,()=>{m||(T(at,`RPC '${e}' stream ${i} transport opened.`),g.Qo())}),p(c,d.iO.EventType.CLOSE,()=>{m||(m=!0,T(at,`RPC '${e}' stream ${i} transport closed`),g.Uo())}),p(c,d.iO.EventType.ERROR,t=>{m||(m=!0,_(at,`RPC '${e}' stream ${i} transport errored:`,t),g.Uo(new N(S.UNAVAILABLE,"The operation could not be completed")))}),p(c,d.iO.EventType.MESSAGE,t=>{var n;if(!m){let s=t.data[0];s||x();let a=(null==s?void 0:s.error)||(null===(n=s[0])||void 0===n?void 0:n.error);if(a){T(at,`RPC '${e}' stream ${i} received error:`,a);let t=a.status,n=function(e){let t=r[e];if(void 0!==t)return rk(t)}(t),s=a.message;void 0===n&&(n=S.INTERNAL,s="Unknown error status: "+t+" with message "+a.message),m=!0,g.Uo(new N(n,s)),c.close()}else T(at,`RPC '${e}' stream ${i} received:`,s),g.Ko(s)}}),p(o,d.Jh.STAT_EVENT,t=>{t.stat===d.ro.PROXY?T(at,`RPC '${e}' stream ${i} detected buffering proxy`):t.stat===d.ro.NOPROXY&&T(at,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{g.$o()},0),g}}function ar(){return"undefined"!=typeof window?window:null}function ai(){return"undefined"!=typeof document?document:null}function as(e){return new rH(e,!0)}class aa{constructor(e,t,n=1e3,r=1.5,i=6e4){this.Ti=e,this.timerId=t,this.Go=n,this.zo=r,this.jo=i,this.Ho=0,this.Jo=null,this.Yo=Date.now(),this.reset()}reset(){this.Ho=0}Zo(){this.Ho=this.jo}Xo(e){this.cancel();let t=Math.floor(this.Ho+this.e_()),n=Math.max(0,Date.now()-this.Yo),r=Math.max(0,t-n);r>0&&T("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Ho} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Jo=this.Ti.enqueueAfterDelay(this.timerId,r,()=>(this.Yo=Date.now(),e())),this.Ho*=this.zo,this.Ho<this.Go&&(this.Ho=this.Go),this.Ho>this.jo&&(this.Ho=this.jo)}t_(){null!==this.Jo&&(this.Jo.skipDelay(),this.Jo=null)}cancel(){null!==this.Jo&&(this.Jo.cancel(),this.Jo=null)}e_(){return(Math.random()-.5)*this.Ho}}let ao="PersistentStream";class al{constructor(e,t,n,r,i,s,a,o){this.Ti=e,this.n_=n,this.r_=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.i_=0,this.s_=null,this.o_=null,this.stream=null,this.__=0,this.a_=new aa(e,t)}u_(){return 1===this.state||5===this.state||this.c_()}c_(){return 2===this.state||3===this.state}start(){this.__=0,4!==this.state?this.auth():this.l_()}async stop(){this.u_()&&await this.close(0)}h_(){this.state=0,this.a_.reset()}P_(){this.c_()&&null===this.s_&&(this.s_=this.Ti.enqueueAfterDelay(this.n_,6e4,()=>this.T_()))}I_(e){this.E_(),this.stream.send(e)}async T_(){if(this.c_())return this.close(0)}E_(){this.s_&&(this.s_.cancel(),this.s_=null)}d_(){this.o_&&(this.o_.cancel(),this.o_=null)}async close(e,t){this.E_(),this.d_(),this.a_.cancel(),this.i_++,4!==e?this.a_.reset():t&&t.code===S.RESOURCE_EXHAUSTED?(E(t.toString()),E("Using maximum backoff delay to prevent overloading the backend."),this.a_.Zo()):t&&t.code===S.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.A_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Lo(t)}A_(){}auth(){this.state=1;let e=this.R_(this.i_),t=this.i_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.i_===t&&this.V_(e,n)},t=>{e(()=>{let e=new N(S.UNKNOWN,"Fetching auth token failed: "+t.message);return this.m_(e)})})}V_(e,t){let n=this.R_(this.i_);this.stream=this.f_(e,t),this.stream.xo(()=>{n(()=>this.listener.xo())}),this.stream.No(()=>{n(()=>(this.state=2,this.o_=this.Ti.enqueueAfterDelay(this.r_,1e4,()=>(this.c_()&&(this.state=3),Promise.resolve())),this.listener.No()))}),this.stream.Lo(e=>{n(()=>this.m_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.__?this.g_(e):this.onNext(e))})}l_(){this.state=5,this.a_.Xo(async()=>{this.state=0,this.start()})}m_(e){return T(ao,`close with error: ${e}`),this.stream=null,this.close(4,e)}R_(e){return t=>{this.Ti.enqueueAndForget(()=>this.i_===e?t():(T(ao,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class au extends al{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}f_(e,t){return this.connection.Wo("Listen",e,t)}g_(e){return this.onNext(e)}onNext(e){this.a_.reset();let t=function(e,t){let n;if("targetChange"in t){var r,i;t.targetChange;let s="NO_CHANGE"===(r=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===r?1:"REMOVE"===r?2:"CURRENT"===r?3:"RESET"===r?4:x(),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(void 0===i||"string"==typeof i||x(),tV.fromBase64String(i||"")):(void 0===i||i instanceof m||i instanceof Uint8Array||x(),tV.fromUint8Array(i||new Uint8Array))),l=t.targetChange.cause;n=new rq(s,a,o,l&&new N(void 0===l.code?S.UNKNOWN:rk(l.code),l.message||"")||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=r5(e,r.document.name),s=rJ(r.document.updateTime),a=r.document.createTime?rJ(r.document.createTime):$.min(),o=new nl({mapValue:{fields:r.document.fields}}),l=nu.newFoundDocument(i,s,a,o);n=new rP(r.targetIds||[],r.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=r5(e,r.document),s=r.readTime?rJ(r.readTime):$.min(),a=nu.newNoDocument(i,s);n=new rP([],r.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=r5(e,r.document);n=new rP([],r.removedTargetIds||[],i,null)}else{if(!("filter"in t))return x();{t.filter;let e=t.filter;e.targetId;let{count:r=0,unchangedNames:i}=e,s=new rD(r,i);n=new rU(e.targetId,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return $.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?$.min():t.readTime?rJ(t.readTime):$.min()}(e);return this.listener.p_(t,n)}y_(e){let t={};t.database=r8(this.serializer),t.addTarget=function(e,t){let n;let r=t.target;if((n=nL(r)?{documents:ir(e,r)}:{query:ii(e,r).ht}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=rZ(e,t.resumeToken);let r=rW(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo($.min())>0){n.readTime=rY(e,t.snapshotVersion.toTimestamp());let r=rW(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);let n=function(e,t){let n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return x()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.I_(t)}w_(e){let t={};t.database=r8(this.serializer),t.removeTarget=e,this.I_(t)}}class ah extends al{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}get S_(){return this.__>0}start(){this.lastStreamToken=void 0,super.start()}A_(){this.S_&&this.b_([])}f_(e,t){return this.connection.Wo("Write",e,t)}g_(e){return e.streamToken||x(),this.lastStreamToken=e.streamToken,e.writeResults&&0!==e.writeResults.length&&x(),this.listener.D_()}onNext(e){var t,n;e.streamToken||x(),this.lastStreamToken=e.streamToken,this.a_.reset();let r=(t=e.writeResults,n=e.commitTime,t&&t.length>0?(void 0!==n||x(),t.map(e=>{let t;return(t=e.updateTime?rJ(e.updateTime):rJ(n)).isEqual($.min())&&(t=rJ(n)),new rd(t,e.transformResults||[])})):[]),i=rJ(e.commitTime);return this.listener.v_(i,r)}C_(){let e={};e.database=r8(this.serializer),this.I_(e)}b_(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>ie(this.serializer,e))};this.I_(t)}}class ac{}class ad extends ac{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.F_=!1}M_(){if(this.F_)throw new N(S.FAILED_PRECONDITION,"The client has already been terminated.")}So(e,t,n,r){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.So(e,r0(t,n),r,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(S.UNKNOWN,e.toString())})}Co(e,t,n,r,i){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Co(e,r0(t,n),r,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(S.UNKNOWN,e.toString())})}terminate(){this.F_=!0,this.connection.terminate()}}class af{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.x_=0,this.O_=null,this.N_=!0}B_(){0===this.x_&&(this.L_("Unknown"),this.O_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.O_=null,this.k_("Backend didn't respond within 10 seconds."),this.L_("Offline"),Promise.resolve())))}q_(e){"Online"===this.state?this.L_("Unknown"):(this.x_++,this.x_>=1&&(this.Q_(),this.k_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.L_("Offline")))}set(e){this.Q_(),this.x_=0,"Online"===e&&(this.N_=!1),this.L_(e)}L_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}k_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.N_?(E(t),this.N_=!1):T("OnlineStateTracker",t)}Q_(){null!==this.O_&&(this.O_.cancel(),this.O_=null)}}let am="RemoteStore";class ag{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.U_=[],this.K_=new Map,this.W_=new Set,this.G_=[],this.z_=i,this.z_.To(e=>{n.enqueueAndForget(async()=>{ab(this)&&(T(am,"Restarting streams for network reachability change."),await async function(e){e.W_.add(4),await ay(e),e.j_.set("Unknown"),e.W_.delete(4),await ap(e)}(this))})}),this.j_=new af(n,r)}}async function ap(e){if(ab(e))for(let t of e.G_)await t(!0)}async function ay(e){for(let t of e.G_)await t(!1)}function aw(e,t){e.K_.has(t.targetId)||(e.K_.set(t.targetId,t),a_(e)?aE(e):aq(e).c_()&&aI(e,t))}function av(e,t){let n=aq(e);e.K_.delete(t),n.c_()&&aT(e,t),0===e.K_.size&&(n.c_()?n.P_():ab(e)&&e.j_.set("Unknown"))}function aI(e,t){if(e.H_.Ne(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo($.min())>0){let n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}aq(e).y_(t)}function aT(e,t){e.H_.Ne(t),aq(e).w_(t)}function aE(e){e.H_=new rz({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),lt:t=>e.K_.get(t)||null,it:()=>e.datastore.serializer.databaseId}),aq(e).start(),e.j_.B_()}function a_(e){return ab(e)&&!aq(e).u_()&&e.K_.size>0}function ab(e){return 0===e.W_.size}async function ax(e){e.j_.set("Online")}async function aS(e){e.K_.forEach((t,n)=>{aI(e,t)})}async function aN(e,t){e.H_=void 0,a_(e)?(e.j_.q_(t),aE(e)):e.j_.set("Unknown")}async function aC(e,t,n){if(e.j_.set("Online"),t instanceof rq&&2===t.state&&t.cause)try{await async function(e,t){let n=t.cause;for(let r of t.targetIds)e.K_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.K_.delete(r),e.H_.removeTarget(r))}(e,t)}catch(n){T(am,"Failed to remove targets %s: %s ",t.targetIds.join(","),n),await aD(e,n)}else if(t instanceof rP?e.H_.We(t):t instanceof rU?e.H_.Ze(t):e.H_.je(t),!n.isEqual($.min()))try{let t=await sL(e.localStore);n.compareTo(t)>=0&&await function(e,t){let n=e.H_.ot(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){let i=e.K_.get(r);i&&e.K_.set(r,i.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{let r=e.K_.get(t);if(!r)return;e.K_.set(t,r.withResumeToken(tV.EMPTY_BYTE_STRING,r.snapshotVersion)),aT(e,t);let i=new iu(r.target,t,n,r.sequenceNumber);aI(e,i)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){T(am,"Failed to raise snapshot:",t),await aD(e,t)}}async function aD(e,t,n){if(!eg(t))throw t;e.W_.add(1),await ay(e),e.j_.set("Offline"),n||(n=()=>sL(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{T(am,"Retrying IndexedDB access"),await n(),e.W_.delete(1),await ap(e)})}function ak(e,t){return t().catch(n=>aD(e,n,t))}async function aA(e){let t=aB(e),n=e.U_.length>0?e.U_[e.U_.length-1].batchId:-1;for(;ab(e)&&e.U_.length<10;)try{let r=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}(e.localStore,n);if(null===r){0===e.U_.length&&t.P_();break}n=r.batchId,function(e,t){e.U_.push(t);let n=aB(e);n.c_()&&n.S_&&n.b_(t.mutations)}(e,r)}catch(t){await aD(e,t)}aV(e)&&aR(e)}function aV(e){return ab(e)&&!aB(e).u_()&&e.U_.length>0}function aR(e){aB(e).start()}async function aL(e){aB(e).C_()}async function aM(e){let t=aB(e);for(let n of e.U_)t.b_(n.mutations)}async function aO(e,t,n){let r=e.U_.shift(),i=rN.from(r,t,n);await ak(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await aA(e)}async function aF(e,t){t&&aB(e).S_&&await async function(e,t){var n;if(function(e){switch(e){case S.OK:return x();case S.CANCELLED:case S.UNKNOWN:case S.DEADLINE_EXCEEDED:case S.RESOURCE_EXHAUSTED:case S.INTERNAL:case S.UNAVAILABLE:case S.UNAUTHENTICATED:return!1;case S.INVALID_ARGUMENT:case S.NOT_FOUND:case S.ALREADY_EXISTS:case S.PERMISSION_DENIED:case S.FAILED_PRECONDITION:case S.ABORTED:case S.OUT_OF_RANGE:case S.UNIMPLEMENTED:case S.DATA_LOSS:return!0;default:return x()}}(n=t.code)&&n!==S.ABORTED){let n=e.U_.shift();aB(e).h_(),await ak(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await aA(e)}}(e,t),aV(e)&&aR(e)}async function aP(e,t){e.asyncQueue.verifyOperationInProgress(),T(am,"RemoteStore received new credentials");let n=ab(e);e.W_.add(3),await ay(e),n&&e.j_.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.W_.delete(3),await ap(e)}async function aU(e,t){t?(e.W_.delete(2),await ap(e)):t||(e.W_.add(2),await ay(e),e.j_.set("Unknown"))}function aq(e){var t,n,r;return e.J_||(e.J_=(t=e.datastore,n=e.asyncQueue,r={xo:ax.bind(null,e),No:aS.bind(null,e),Lo:aN.bind(null,e),p_:aC.bind(null,e)},t.M_(),new au(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r)),e.G_.push(async t=>{t?(e.J_.h_(),a_(e)?aE(e):e.j_.set("Unknown")):(await e.J_.stop(),e.H_=void 0)})),e.J_}function aB(e){var t,n,r;return e.Y_||(e.Y_=(t=e.datastore,n=e.asyncQueue,r={xo:()=>Promise.resolve(),No:aL.bind(null,e),Lo:aF.bind(null,e),D_:aM.bind(null,e),v_:aO.bind(null,e)},t.M_(),new ah(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r)),e.G_.push(async t=>{t?(e.Y_.h_(),await aA(e)):(await e.Y_.stop(),e.U_.length>0&&(T(am,`Stopping write stream with ${e.U_.length} pending writes`),e.U_=[]))})),e.Y_}class az{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new C,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){let s=new az(e,t,Date.now()+n,r,i);return s.start(n),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new N(S.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function a$(e,t){if(E("AsyncQueue",`${t}: ${e}`),eg(e))return new N(S.UNAVAILABLE,`${t}: ${e}`);throw e}class aK{static emptySet(e){return new aK(e.comparator)}constructor(e){this.comparator=e?(t,n)=>e(t,n)||W.comparator(t.key,n.key):(e,t)=>W.comparator(e.key,t.key),this.keyedMap=n1(),this.sortedSet=new tb(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof aK)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let n=new aK;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class aG{constructor(){this.Z_=new tb(W.comparator)}track(e){let t=e.doc.key,n=this.Z_.get(t);n?0!==e.type&&3===n.type?this.Z_=this.Z_.insert(t,e):3===e.type&&1!==n.type?this.Z_=this.Z_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Z_=this.Z_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Z_=this.Z_.remove(t):1===e.type&&2===n.type?this.Z_=this.Z_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):x():this.Z_=this.Z_.insert(t,e)}X_(){let e=[];return this.Z_.inorderTraversal((t,n)=>{e.push(n)}),e}}class aj{constructor(e,t,n,r,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,n,r,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new aj(e,t,aK.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&nj(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class aQ{constructor(){this.ea=void 0,this.ta=[]}na(){return this.ta.some(e=>e.ra())}}class aH{constructor(){this.queries=aW(),this.onlineState="Unknown",this.ia=new Set}terminate(){!function(e,t){let n=e.queries;e.queries=aW(),n.forEach((e,n)=>{for(let e of n.ta)e.onError(t)})}(this,new N(S.ABORTED,"Firestore shutting down"))}}function aW(){return new nJ(e=>nQ(e),nj)}async function aY(e,t){let n=3,r=t.query,i=e.queries.get(r);i?!i.na()&&t.ra()&&(n=2):(i=new aQ,n=t.ra()?0:1);try{switch(n){case 0:i.ea=await e.onListen(r,!0);break;case 1:i.ea=await e.onListen(r,!1);break;case 2:await e.onFirstRemoteStoreListen(r)}}catch(n){let e=a$(n,`Initialization of query '${nH(t.query)}' failed`);return void t.onError(e)}e.queries.set(r,i),i.ta.push(t),t.sa(e.onlineState),i.ea&&t.oa(i.ea)&&a0(e)}async function aZ(e,t){let n=t.query,r=3,i=e.queries.get(n);if(i){let e=i.ta.indexOf(t);e>=0&&(i.ta.splice(e,1),0===i.ta.length?r=t.ra()?0:1:!i.na()&&t.ra()&&(r=2))}switch(r){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}}function aJ(e,t){let n=!1;for(let r of t){let t=r.query,i=e.queries.get(t);if(i){for(let e of i.ta)e.oa(r)&&(n=!0);i.ea=r}}n&&a0(e)}function aX(e,t,n){let r=e.queries.get(t);if(r)for(let e of r.ta)e.onError(n);e.queries.delete(t)}function a0(e){e.ia.forEach(e=>{e.next()})}(a=s||(s={}))._a="default",a.Cache="cache";class a1{constructor(e,t,n){this.query=e,this.aa=t,this.ua=!1,this.ca=null,this.onlineState="Unknown",this.options=n||{}}oa(e){if(!this.options.includeMetadataChanges){let t=[];for(let n of e.docChanges)3!==n.type&&t.push(n);e=new aj(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.ua?this.la(e)&&(this.aa.next(e),t=!0):this.ha(e,this.onlineState)&&(this.Pa(e),t=!0),this.ca=e,t}onError(e){this.aa.error(e)}sa(e){this.onlineState=e;let t=!1;return this.ca&&!this.ua&&this.ha(this.ca,e)&&(this.Pa(this.ca),t=!0),t}ha(e,t){return!(e.fromCache&&this.ra())||(!this.options.Ta||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}la(e){if(e.docChanges.length>0)return!0;let t=this.ca&&this.ca.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Pa(e){e=aj.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.ua=!0,this.aa.next(e)}ra(){return this.options.source!==s.Cache}}class a2{constructor(e){this.key=e}}class a5{constructor(e){this.key=e}}class a3{constructor(e,t){this.query=e,this.fa=t,this.ga=null,this.hasCachedResults=!1,this.current=!1,this.pa=n8(),this.mutatedKeys=n8(),this.ya=nZ(e),this.wa=new aK(this.ya)}get Sa(){return this.fa}ba(e,t){let n=t?t.Da:new aG,r=t?t.wa:this.wa,i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1,o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,l="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{let u=r.get(e),h=nW(this.query,t)?t:null,c=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations),f=!1;u&&h?u.data.isEqual(h.data)?c!==d&&(n.track({type:3,doc:h}),f=!0):this.va(u,h)||(n.track({type:2,doc:h}),f=!0,(o&&this.ya(h,o)>0||l&&0>this.ya(h,l))&&(a=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(h?(s=s.add(h),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{wa:s,Da:n,ls:a,mutatedKeys:i}}va(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){let i=this.wa;this.wa=e.wa,this.mutatedKeys=e.mutatedKeys;let s=e.Da.X_();s.sort((e,t)=>(function(e,t){let n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return x()}};return n(e)-n(t)})(e.type,t.type)||this.ya(e.doc,t.doc)),this.Ca(n),r=null!=r&&r;let a=t&&!r?this.Fa():[],o=0===this.pa.size&&this.current&&!r?1:0,l=o!==this.ga;return(this.ga=o,0!==s.length||l)?{snapshot:new aj(this.query,e.wa,i,s,e.mutatedKeys,0===o,l,!1,!!n&&n.resumeToken.approximateByteSize()>0),Ma:a}:{Ma:a}}sa(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({wa:this.wa,Da:new aG,mutatedKeys:this.mutatedKeys,ls:!1},!1)):{Ma:[]}}xa(e){return!this.fa.has(e)&&!!this.wa.has(e)&&!this.wa.get(e).hasLocalMutations}Ca(e){e&&(e.addedDocuments.forEach(e=>this.fa=this.fa.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.fa=this.fa.delete(e)),this.current=e.current)}Fa(){if(!this.current)return[];let e=this.pa;this.pa=n8(),this.wa.forEach(e=>{this.xa(e.key)&&(this.pa=this.pa.add(e.key))});let t=[];return e.forEach(e=>{this.pa.has(e)||t.push(new a5(e))}),this.pa.forEach(n=>{e.has(n)||t.push(new a2(n))}),t}Oa(e){this.fa=e.gs,this.pa=n8();let t=this.ba(e.documents);return this.applyChanges(t,!0)}Na(){return aj.fromInitialDocuments(this.query,this.wa,this.mutatedKeys,0===this.ga,this.hasCachedResults)}}let a4="SyncEngine";class a8{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class a6{constructor(e){this.key=e,this.Ba=!1}}class a9{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.La={},this.ka=new nJ(e=>nQ(e),nj),this.qa=new Map,this.Qa=new Set,this.$a=new tb(W.comparator),this.Ua=new Map,this.Ka=new sd,this.Wa={},this.Ga=new Map,this.za=i1.Kn(),this.onlineState="Unknown",this.ja=void 0}get isPrimaryClient(){return!0===this.ja}}async function a7(e,t,n=!0){let r;let i=oC(e),s=i.ka.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),r=s.view.Na()):r=await ot(i,t,n,!0),r}async function oe(e,t){let n=oC(e);await ot(n,t,!0,!1)}async function ot(e,t,n,r){let i;let s=await sO(e.localStore,n$(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,n);return r&&(i=await on(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&aw(e.remoteStore,s),i}async function on(e,t,n,r,i){e.Ha=(t,n,r)=>(async function(e,t,n,r){let i=t.view.ba(n);i.ls&&(i=await sP(e.localStore,t.query,!1).then(({documents:e})=>t.view.ba(e,i)));let s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return om(e,t.targetId,o.Ma),o.snapshot})(e,t,n,r);let s=await sP(e.localStore,t,!0),a=new a3(t,s.gs),o=a.ba(s.documents),l=rF.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);om(e,n,u.Ma);let h=new a8(t,n,a);return e.ka.set(t,h),e.qa.has(n)?e.qa.get(n).push(t):e.qa.set(n,[t]),u.snapshot}async function or(e,t,n){let r=e.ka.get(t),i=e.qa.get(r.targetId);if(i.length>1)return e.qa.set(r.targetId,i.filter(e=>!nj(e,t))),void e.ka.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(r.targetId),e.sharedClientState.isActiveQueryTarget(r.targetId)||await sF(e.localStore,r.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(r.targetId),n&&av(e.remoteStore,r.targetId),od(e,r.targetId)}).catch(eo)):(od(e,r.targetId),await sF(e.localStore,r.targetId,!0))}async function oi(e,t){let n=e.ka.get(t),r=e.qa.get(n.targetId);e.isPrimaryClient&&1===r.length&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),av(e.remoteStore,n.targetId))}async function os(e,t){try{let n=await function(e,t){let n=t.snapshotVersion,r=e.Ts;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.ds.newChangeBuffer({trackRemovals:!0});r=e.Ts;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=r.get(o);if(!u)return;a.push(e.Hr.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.Hr.addMatchingKeys(i,s.addedDocuments,o)));let h=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?h=h.withResumeToken(tV.EMPTY_BYTE_STRING,$.min()).withLastLimboFreeSnapshotVersion($.min()):s.resumeToken.approximateByteSize()>0&&(h=h.withResumeToken(s.resumeToken,n)),r=r.insert(o,h),l=h,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.Hr.updateTargetData(i,h))});let o=nX,l=n8();if(t.documentUpdates.forEach(n=>{t.resolvedLimboDocuments.has(n)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,n))}),a.push(sM(i,s,t.documentUpdates).next(e=>{o=e.Vs,l=e.fs})),!n.isEqual($.min())){let t=e.Hr.getLastRemoteSnapshotVersion(i).next(t=>e.Hr.setTargetsMetadata(i,i.currentSequenceNumber,n));a.push(t)}return el.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.Ts=r,t))}(e.localStore,t);t.targetChanges.forEach((t,n)=>{let r=e.Ua.get(n);r&&(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1||x(),t.addedDocuments.size>0?r.Ba=!0:t.modifiedDocuments.size>0?r.Ba||x():t.removedDocuments.size>0&&(r.Ba||x(),r.Ba=!1))}),await op(e,n,t)}catch(e){await eo(e)}}function oa(e,t,n){var r;if(e.isPrimaryClient&&0===n||!e.isPrimaryClient&&1===n){let n;let i=[];e.ka.forEach((e,n)=>{let r=n.view.sa(t);r.snapshot&&i.push(r.snapshot)}),(r=e.eventManager).onlineState=t,n=!1,r.queries.forEach((e,r)=>{for(let e of r.ta)e.sa(t)&&(n=!0)}),n&&a0(r),i.length&&e.La.p_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function oo(e,t,n){e.sharedClientState.updateQueryState(t,"rejected",n);let r=e.Ua.get(t),i=r&&r.key;if(i){let n=new tb(W.comparator);n=n.insert(i,nu.newNoDocument(i,$.min()));let r=n8().add(i),s=new rO($.min(),new Map,new tb(U),n,r);await os(e,s),e.$a=e.$a.remove(i),e.Ua.delete(t),og(e)}else await sF(e.localStore,t,!1).then(()=>od(e,t,n)).catch(eo)}async function ol(e,t){var n;let r=t.batch.batchId;try{let i=await (n=e.localStore).persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let r=t.batch.keys(),i=n.ds.newChangeBuffer({trackRemovals:!0});return(function(e,t,n,r){let i=n.batch,s=i.keys(),a=el.resolve();return s.forEach(e=>{a=a.next(()=>r.getEntry(t,e)).next(t=>{let s=n.docVersions.get(e);null!==s||x(),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(n,e,t,i).next(()=>i.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=n8();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))});oc(e,r,null),oh(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),await op(e,i)}catch(e){await eo(e)}}async function ou(e,t,n){var r;try{let i=await (r=e.localStore).persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return r.mutationQueue.lookupMutationBatch(e,t).next(t=>(null!==t||x(),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t))).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,n)).next(()=>r.localDocuments.getDocuments(e,n))});oc(e,t,n),oh(e,t),e.sharedClientState.updateMutationState(t,"rejected",n),await op(e,i)}catch(e){await eo(e)}}function oh(e,t){(e.Ga.get(t)||[]).forEach(e=>{e.resolve()}),e.Ga.delete(t)}function oc(e,t,n){let r=e.Wa[e.currentUser.toKey()];if(r){let i=r.get(t);i&&(n?i.reject(n):i.resolve(),r=r.remove(t)),e.Wa[e.currentUser.toKey()]=r}}function od(e,t,n=null){for(let r of(e.sharedClientState.removeLocalQueryTarget(t),e.qa.get(t)))e.ka.delete(r),n&&e.La.Ja(r,n);e.qa.delete(t),e.isPrimaryClient&&e.Ka.br(t).forEach(t=>{e.Ka.containsKey(t)||of(e,t)})}function of(e,t){e.Qa.delete(t.path.canonicalString());let n=e.$a.get(t);null!==n&&(av(e.remoteStore,n),e.$a=e.$a.remove(t),e.Ua.delete(n),og(e))}function om(e,t,n){for(let r of n)r instanceof a2?(e.Ka.addReference(r.key,t),function(e,t){let n=t.key,r=n.path.canonicalString();e.$a.get(n)||e.Qa.has(r)||(T(a4,"New document in limbo: "+n),e.Qa.add(r),og(e))}(e,r)):r instanceof a5?(T(a4,"Document no longer in limbo: "+r.key),e.Ka.removeReference(r.key,t),e.Ka.containsKey(r.key)||of(e,r.key)):x()}function og(e){for(;e.Qa.size>0&&e.$a.size<e.maxConcurrentLimboResolutions;){let t=e.Qa.values().next().value;e.Qa.delete(t);let n=new W(j.fromString(t)),r=e.za.next();e.Ua.set(r,new a6(n)),e.$a=e.$a.insert(n,r),aw(e.remoteStore,new iu(n$(nU(n.path)),r,"TargetPurposeLimboResolution",e_.ae))}}async function op(e,t,n){let r=[],i=[],s=[];e.ka.isEmpty()||(e.ka.forEach((a,o)=>{s.push(e.Ha(o,t,n).then(t=>{var s;if((t||n)&&e.isPrimaryClient){let r=t?!t.fromCache:null===(s=null==n?void 0:n.targetChanges.get(o.targetId))||void 0===s?void 0:s.current;e.sharedClientState.updateQueryState(o.targetId,r?"current":"not-current")}if(t){r.push(t);let e=sC.Yi(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.La.p_(r),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>el.forEach(t,t=>el.forEach(t.Hi,r=>e.persistence.referenceDelegate.addReference(n,t.targetId,r)).next(()=>el.forEach(t.Ji,r=>e.persistence.referenceDelegate.removeReference(n,t.targetId,r)))))}catch(e){if(!eg(e))throw e;T(sA,"Failed to update sequence numbers: "+e)}for(let n of t){let t=n.targetId;if(!n.fromCache){let n=e.Ts.get(t),r=n.snapshotVersion,i=n.withLastLimboFreeSnapshotVersion(r);e.Ts=e.Ts.insert(t,i)}}}(e.localStore,i))}async function oy(e,t){var n;if(!e.currentUser.isEqual(t)){T(a4,"User change. New user:",t.toKey());let r=await sR(e.localStore,t);e.currentUser=t,n="'waitForPendingWrites' promise is rejected due to a user change.",e.Ga.forEach(e=>{e.forEach(e=>{e.reject(new N(S.CANCELLED,n))})}),e.Ga.clear(),e.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await op(e,r.Rs)}}function ow(e,t){let n=e.Ua.get(t);if(n&&n.Ba)return n8().add(n.key);{let n=n8(),r=e.qa.get(t);if(!r)return n;for(let t of r){let r=e.ka.get(t);n=n.unionWith(r.view.Sa)}return n}}async function ov(e,t){let n=await sP(e.localStore,t.query,!0),r=t.view.Oa(n);return e.isPrimaryClient&&om(e,t.targetId,r.Ma),r}async function oI(e,t){return sq(e.localStore,t).then(t=>op(e,t))}async function oT(e,t,n,r){let i=await function(e,t){let n=e.mutationQueue;return e.persistence.runTransaction("Lookup mutation documents","readonly",r=>n.Ln(r,t).next(t=>t?e.localDocuments.getDocuments(r,t):el.resolve(null)))}(e.localStore,t);null!==i?("pending"===n?await aA(e.remoteStore):"acknowledged"===n||"rejected"===n?(oc(e,t,r||null),oh(e,t),function(e,t){e.mutationQueue.qn(t)}(e.localStore,t)):x(),await op(e,i)):T(a4,"Cannot apply mutation batch with id: "+t)}async function oE(e,t){if(oC(e),oD(e),!0===t&&!0!==e.ja){let t=e.sharedClientState.getAllActiveQueryTargets(),n=await o_(e,t.toArray());for(let t of(e.ja=!0,await aU(e.remoteStore,!0),n))aw(e.remoteStore,t)}else if(!1===t&&!1!==e.ja){let t=[],n=Promise.resolve();e.qa.forEach((r,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):n=n.then(()=>(od(e,i),sF(e.localStore,i,!0))),av(e.remoteStore,i)}),await n,await o_(e,t),e.Ua.forEach((t,n)=>{av(e.remoteStore,n)}),e.Ka.Dr(),e.Ua=new Map,e.$a=new tb(W.comparator),e.ja=!1,await aU(e.remoteStore,!1)}}async function o_(e,t,n){let r=[],i=[];for(let n of t){let t;let s=e.qa.get(n);if(s&&0!==s.length)for(let n of(t=await sO(e.localStore,n$(s[0])),s)){let t=e.ka.get(n),r=await ov(e,t);r.snapshot&&i.push(r.snapshot)}else{let r=await sU(e.localStore,n);t=await sO(e.localStore,r),await on(e,ob(r),n,!1,t.resumeToken)}r.push(t)}return e.La.p_(i),r}function ob(e){var t,n,r,i;return t=e.path,n=e.collectionGroup,r=e.orderBy,i=e.filters,new nP(t,n,r,i,e.limit,"F",e.startAt,e.endAt)}function ox(e){return e.localStore.persistence.zi()}async function oS(e,t,n,r){if(e.ja)return void T(a4,"Ignoring unexpected query state notification.");let i=e.qa.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{let r=await sq(e.localStore,nY(i[0])),s=rO.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,tV.EMPTY_BYTE_STRING);await op(e,r,s);break}case"rejected":await sF(e.localStore,t,!0),od(e,t,r);break;default:x()}}async function oN(e,t,n){let r=oC(e);if(r.ja){for(let e of t){if(r.qa.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){T(a4,"Adding an already active target "+e);continue}let t=await sU(r.localStore,e),n=await sO(r.localStore,t);await on(r,ob(t),n.targetId,!1,n.resumeToken),aw(r.remoteStore,n)}for(let e of n)r.qa.has(e)&&await sF(r.localStore,e,!1).then(()=>{av(r.remoteStore,e),od(r,e)}).catch(eo)}}function oC(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=os.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=ow.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=oo.bind(null,e),e.La.p_=aJ.bind(null,e.eventManager),e.La.Ja=aX.bind(null,e.eventManager),e}function oD(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=ol.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=ou.bind(null,e),e}class ok{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=as(e.databaseInfo.databaseId),this.sharedClientState=this.Za(e),this.persistence=this.Xa(e),await this.persistence.start(),this.localStore=this.eu(e),this.gcScheduler=this.tu(e,this.localStore),this.indexBackfillerScheduler=this.nu(e,this.localStore)}tu(e,t){return null}nu(e,t){return null}eu(e){var t;return t=this.persistence,new sV(t,new sk,e.initialUser,this.serializer)}Xa(e){return new sw(sI.ri,this.serializer)}Za(e){return new s1}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}ok.provider={build:()=>new ok};class oA extends ok{constructor(e){super(),this.cacheSizeBytes=e}tu(e,t){return this.persistence.referenceDelegate instanceof sT||x(),new i6(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Xa(e){let t=void 0!==this.cacheSizeBytes?iW.withCacheSize(this.cacheSizeBytes):iW.DEFAULT;return new sw(e=>sT.ri(e,t),this.serializer)}}class oV extends ok{constructor(e,t,n){super(),this.ru=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.ru.initialize(this,e),await oD(this.ru.syncEngine),await aA(this.ru.remoteStore),await this.persistence.Ci(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}eu(e){var t;return t=this.persistence,new sV(t,new sk,e.initialUser,this.serializer)}tu(e,t){return new i6(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}nu(e,t){let n=new eE(t,this.persistence);return new eT(e.asyncQueue,n)}Xa(e){let t=sN(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?iW.withCacheSize(this.cacheSizeBytes):iW.DEFAULT;return new sS(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,ar(),ai(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Za(e){return new s1}}class oR{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>oa(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=oy.bind(null,this.syncEngine),await aU(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new aH}createDatastore(e){let t=as(e.databaseInfo.databaseId),n=new an(e.databaseInfo);return new ad(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){var t;return t=this.localStore,new ag(t,this.datastore,e.asyncQueue,e=>oa(this.syncEngine,e,0),s3.D()?new s3:new s2)}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){let o=new a9(e,t,n,r,i,s);return a&&(o.ja=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(e){T(am,"RemoteStore shutting down."),e.W_.add(5),await ay(e),e.z_.shutdown(),e.j_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate(),null===(t=this.eventManager)||void 0===t||t.terminate()}}oR.provider={build:()=>new oR};class oL{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.iu(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.iu(this.observer.error,e):E("Uncaught Error in snapshot listener:",e.toString()))}su(){this.muted=!0}iu(e,t){setTimeout(()=>{this.muted||e(t)},0)}}let oM="FirestoreClient";class oO{constructor(e,t,n,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=y.UNAUTHENTICATED,this.clientId=P.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(n,async e=>{T(oM,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(T(oM,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new C;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){let t=a$(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function oF(e,t){e.asyncQueue.verifyOperationInProgress(),T(oM,"Initializing OfflineComponentProvider");let n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await sR(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function oP(e,t){e.asyncQueue.verifyOperationInProgress();let n=await oU(e);T(oM,"Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>aP(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>aP(t.remoteStore,n)),e._onlineComponents=t}async function oU(e){if(!e._offlineComponents){if(e._uninitializedComponentsProvider){T(oM,"Using user provided OfflineComponentProvider");try{await oF(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===S.FAILED_PRECONDITION||t.code===S.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;_("Error using user provided cache. Falling back to memory cache: "+t),await oF(e,new ok)}}else T(oM,"Using default OfflineComponentProvider"),await oF(e,new oA(void 0))}return e._offlineComponents}async function oq(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(T(oM,"Using user provided OnlineComponentProvider"),await oP(e,e._uninitializedComponentsProvider._online)):(T(oM,"Using default OnlineComponentProvider"),await oP(e,new oR))),e._onlineComponents}async function oB(e){let t=await oq(e),n=t.eventManager;return n.onListen=a7.bind(null,t.syncEngine),n.onUnlisten=or.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=oe.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=oi.bind(null,t.syncEngine),n}function oz(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let o$=new Map;function oK(e,t,n){if(!n)throw new N(S.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function oG(e){if(!W.isDocumentKey(e))throw new N(S.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function oj(e){if(W.isDocumentKey(e))throw new N(S.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function oQ(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let n=(t=e).constructor?t.constructor.name:null;return n?`a custom ${n} object`:"an object"}}return"function"==typeof e?"a function":x()}function oH(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new N(S.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let n=oQ(e);throw new N(S.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}let oW="firestore.googleapis.com";class oY{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new N(S.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=oW,this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new N(S.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,n,r){if(!0===t&&!0===r)throw new N(S.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)})("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=oz(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new N(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new N(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new N(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,n;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class oZ{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new oY({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new N(S.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new N(S.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new oY(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new k;switch(e.type){case"firstParty":return new L(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new N(S.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=o$.get(e);t&&(T("ComponentProvider","Removing Datastore"),o$.delete(e),t.terminate())}(this),Promise.resolve()}}class oJ{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new oJ(this.firestore,e,this._query)}}class oX{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new o0(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new oX(this.firestore,e,this._key)}}class o0 extends oJ{constructor(e,t,n){super(e,t,nU(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new oX(this.firestore,null,new W(e))}withConverter(e){return new o0(this.firestore,e,this._path)}}function o1(e,t,...n){if(e=(0,h.Ku)(e),oK("collection","path",t),e instanceof oZ){let r=j.fromString(t,...n);return oj(r),new o0(e,null,r)}{if(!(e instanceof oX||e instanceof o0))throw new N(S.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(j.fromString(t,...n));return oj(r),new o0(e.firestore,null,r)}}function o2(e,t,...n){if(e=(0,h.Ku)(e),1==arguments.length&&(t=P.newId()),oK("doc","path",t),e instanceof oZ){let r=j.fromString(t,...n);return oG(r),new oX(e,null,new W(r))}{if(!(e instanceof oX||e instanceof o0))throw new N(S.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(j.fromString(t,...n));return oG(r),new oX(e.firestore,e instanceof o0?e.converter:null,new W(r))}}let o5="AsyncQueue";class o3{constructor(e=Promise.resolve()){this.Vu=[],this.mu=!1,this.fu=[],this.gu=null,this.pu=!1,this.yu=!1,this.wu=[],this.a_=new aa(this,"async_queue_retry"),this.Su=()=>{let e=ai();e&&T(o5,"Visibility state changed to "+e.visibilityState),this.a_.t_()},this.bu=e;let t=ai();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Su)}get isShuttingDown(){return this.mu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Du(),this.vu(e)}enterRestrictedMode(e){if(!this.mu){this.mu=!0,this.yu=e||!1;let t=ai();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Su)}}enqueue(e){if(this.Du(),this.mu)return new Promise(()=>{});let t=new C;return this.vu(()=>this.mu&&this.yu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Vu.push(e),this.Cu()))}async Cu(){if(0!==this.Vu.length){try{await this.Vu[0](),this.Vu.shift(),this.a_.reset()}catch(e){if(!eg(e))throw e;T(o5,"Operation failed with retryable error: "+e)}this.Vu.length>0&&this.a_.Xo(()=>this.Cu())}}vu(e){let t=this.bu.then(()=>(this.pu=!0,e().catch(e=>{let t;throw this.gu=e,this.pu=!1,E("INTERNAL UNHANDLED ERROR: ",(t=e.message||"",e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t)),e}).then(e=>(this.pu=!1,e))));return this.bu=t,t}enqueueAfterDelay(e,t,n){this.Du(),this.wu.indexOf(e)>-1&&(t=0);let r=az.createAndSchedule(this,e,t,n,e=>this.Fu(e));return this.fu.push(r),r}Du(){this.gu&&x()}verifyOperationInProgress(){}async Mu(){let e;do e=this.bu,await e;while(e!==this.bu)}xu(e){for(let t of this.fu)if(t.timerId===e)return!0;return!1}Ou(e){return this.Mu().then(()=>{for(let t of(this.fu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.fu))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Mu()})}Nu(e){this.wu.push(e)}Fu(e){let t=this.fu.indexOf(e);this.fu.splice(t,1)}}function o4(e){return function(e,t){if("object"!=typeof e||null===e)return!1;for(let n of t)if(n in e&&"function"==typeof e[n])return!0;return!1}(e,["next","error","complete"])}class o8 extends oZ{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new o3,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new o3(e),this._firestoreClient=void 0,await e}}}function o6(e,t){let n="object"==typeof e?e:(0,o.Sx)(),r=(0,o.j6)(n,"firestore").getImmediate({identifier:"string"==typeof e?e:t||tG});if(!r._initialized){let e=(0,h.yU)("firestore");e&&function(e,t,n,r={}){var i;let s=(e=oH(e,oZ))._getSettings(),a=`${t}:${n}`;if(s.host!==oW&&s.host!==a&&_("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=y.MOCK_USER;else{t=(0,h.Fy)(r.mockUserToken,null===(i=e._app)||void 0===i?void 0:i.options.projectId);let s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new N(S.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new y(s)}e._authCredentials=new A(new D(t,n))}}(r,...e)}return r}function o9(e){if(e._terminated)throw new N(S.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||function(e){var t,n,r,i;let s=e._freezeSettings(),a=(i=e._databaseId,new tK(i,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,oz(s.experimentalLongPollingOptions),s.useFetchStreams));e._componentsProvider||(null===(n=s.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._componentsProvider={_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider}),e._firestoreClient=new oO(e._authCredentials,e._appCheckCredentials,e._queue,a,e._componentsProvider&&function(e){let t=null==e?void 0:e._online.build();return{_offline:null==e?void 0:e._offline.build(t),_online:t}}(e._componentsProvider))}(e),e._firestoreClient}class o7{constructor(e){this._byteString=e}static fromBase64String(e){try{return new o7(tV.fromBase64String(e))}catch(e){throw new N(S.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new o7(tV.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class le{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new N(S.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new H(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class lt{constructor(e){this._methodName=e}}class ln{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new N(S.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new N(S.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return U(this._lat,e._lat)||U(this._long,e._long)}}class lr{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}}let li=/^__.*__$/;class ls{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new rI(e,this.data,this.fieldMask,t,this.fieldTransforms):new rv(e,this.data,t,this.fieldTransforms)}}class la{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new rI(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function lo(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw x()}}class ll{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.Bu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Lu(){return this.settings.Lu}ku(e){return new ll(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}qu(e){var t;let n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ku({path:n,Qu:!1});return r.$u(e),r}Uu(e){var t;let n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ku({path:n,Qu:!1});return r.Bu(),r}Ku(e){return this.ku({path:void 0,Qu:!0})}Wu(e){return lx(e,this.settings.methodName,this.settings.Gu||!1,this.path,this.settings.zu)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Bu(){if(this.path)for(let e=0;e<this.path.length;e++)this.$u(this.path.get(e))}$u(e){if(0===e.length)throw this.Wu("Document fields must not be empty");if(lo(this.Lu)&&li.test(e))throw this.Wu('Document fields cannot begin and end with "__"')}}class lu{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||as(e)}ju(e,t,n,r=!1){return new ll({Lu:e,methodName:t,zu:n,path:H.emptyPath(),Qu:!1,Gu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function lh(e){let t=e._freezeSettings(),n=as(e._databaseId);return new lu(e._databaseId,!!t.ignoreUndefinedProperties,n)}class lc extends lt{_toFieldTransform(e){if(2!==e.Lu)throw 1===e.Lu?e.Wu(`${this._methodName}() can only appear at the top level of your update data`):e.Wu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof lc}}function ld(e,t,n){return new ll({Lu:3,zu:t.settings.zu,methodName:e._methodName,Qu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class lf extends null{_toFieldTransform(e){return new rc(e.path,new rr)}isEqual(e){return e instanceof lf}}class lm extends lt{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){let t=ld(this,e,!0),n=new ri(this.Hu.map(e=>lw(e,t)));return new rc(e.path,n)}isEqual(e){return e instanceof lm&&(0,h.bD)(this.Hu,e.Hu)}}class lg extends lt{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){let t=ld(this,e,!0),n=new ra(this.Hu.map(e=>lw(e,t)));return new rc(e.path,n)}isEqual(e){return e instanceof lg&&(0,h.bD)(this.Hu,e.Hu)}}class lp extends lt{constructor(e,t){super(e),this.Ju=t}_toFieldTransform(e){let t=new rl(e.serializer,re(e.serializer,this.Ju));return new rc(e.path,t)}isEqual(e){return e instanceof lp&&this.Ju===e.Ju}}function ly(e,t,n,r=!1){return lw(n,e.ju(r?4:3,t))}function lw(e,t){if(lI(e=(0,h.Ku)(e)))return lT("Unsupported field value:",t,e),lv(e,t);if(e instanceof lt)return function(e,t){if(!lo(t.Lu))throw t.Wu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Wu(`${e._methodName}() is not currently supported inside arrays`);let n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Qu&&4!==t.Lu)throw t.Wu("Nested arrays are not supported");return function(e,t){let n=[],r=0;for(let i of e){let e=lw(i,t.Ku(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,h.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return re(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let n=z.fromDate(e);return{timestampValue:rY(t.serializer,n)}}if(e instanceof z){let n=new z(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:rY(t.serializer,n)}}if(e instanceof ln)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof o7)return{bytesValue:rZ(t.serializer,e._byteString)};if(e instanceof oX){let n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Wu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:rX(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof lr)return{mapValue:{fields:{[tQ]:{stringValue:tY},[tZ]:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Wu("VectorValues must only contain numeric values.");return n9(t.serializer,e)})}}}}};throw t.Wu(`Unsupported field value: ${oQ(e)}`)}(e,t)}function lv(e,t){let n={};return t_(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):tE(e,(e,r)=>{let i=lw(r,t.qu(e));null!=i&&(n[e]=i)}),{mapValue:{fields:n}}}function lI(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof z||e instanceof ln||e instanceof o7||e instanceof oX||e instanceof lt||e instanceof lr)}function lT(e,t,n){if(!lI(n)||!("object"==typeof n&&null!==n&&(Object.getPrototypeOf(n)===Object.prototype||null===Object.getPrototypeOf(n)))){let r=oQ(n);throw"an object"===r?t.Wu(e+" a custom object"):t.Wu(e+" "+r)}}function lE(e,t,n){if((t=(0,h.Ku)(t))instanceof le)return t._internalPath;if("string"==typeof t)return lb(e,t);throw lx("Field path arguments must be of type string or ",e,!1,void 0,n)}let l_=RegExp("[~\\*/\\[\\]]");function lb(e,t,n){if(t.search(l_)>=0)throw lx(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new le(...t.split("."))._internalPath}catch(r){throw lx(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function lx(e,t,n,r,i){let s=r&&!r.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${r}`),a&&(l+=` in document ${i}`),l+=")"),new N(S.INVALID_ARGUMENT,o+e+l)}function lS(e,t){return e.some(e=>e.isEqual(t))}class lN{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new oX(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new lC(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(lD("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class lC extends lN{data(){return super.data()}}function lD(e,t){return"string"==typeof t?lb(e,t):t instanceof le?t._internalPath:t._delegate._internalPath}function lk(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new N(S.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class lA{}class lV extends lA{}class lR extends lV{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new lR(e,t,n)}_apply(e){let t=this._parse(e);return lz(e._query,t),new oJ(e.firestore,e.converter,nK(e._query,t))}_parse(e){let t=lh(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new N(S.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){lB(a,s);let t=[];for(let n of a)t.push(lq(r,e,n));o={arrayValue:{values:t}}}else o=lq(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||lB(a,s),o=ly(n,t,a,"in"===s||"not-in"===s);return ng.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class lL extends lA{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new lL(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:np.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(let e of t.getFlattenedFilters())lz(n,e),n=nK(n,e)}(e._query,t),new oJ(e.firestore,e.converter,nK(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class lM extends lV{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new lM(e,t)}_apply(e){let t=function(e,t,n){if(null!==e.startAt)throw new N(S.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new N(S.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new nf(t,n)}(e._query,this._field,this._direction);return new oJ(e.firestore,e.converter,function(e,t){let n=e.explicitOrderBy.concat([t]);return new nP(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}class lO extends lV{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new lO(e,t,n)}_apply(e){return new oJ(e.firestore,e.converter,nG(e._query,this._limit,this._limitType))}}class lF extends lV{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new lF(e,t,n)}_apply(e){var t;let n=lU(e,this.type,this._docOrFields,this._inclusive);return new oJ(e.firestore,e.converter,new nP((t=e._query).path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,n,t.endAt))}}class lP extends lV{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new lP(e,t,n)}_apply(e){var t;let n=lU(e,this.type,this._docOrFields,this._inclusive);return new oJ(e.firestore,e.converter,new nP((t=e._query).path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,n))}}function lU(e,t,n,r){if(n[0]=(0,h.Ku)(n[0]),n[0]instanceof lN)return function(e,t,n,r,i){if(!r)throw new N(S.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);let s=[];for(let n of nz(e))if(n.field.isKeyField())s.push(t8(t,r.key));else{let e=r.data.field(n.field);if(tB(e))throw new N(S.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=n.field.canonicalString();throw new N(S.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new nh(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{let i=lh(e.firestore);return function(e,t,n,r,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new N(S.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new N(S.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof l}`);if(!nB(e)&&-1!==l.indexOf("/"))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${l}' contains a slash.`);let n=e.path.child(j.fromString(l));if(!W.isDocumentKey(n))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);let i=new W(n);o.push(t8(t,i))}else{let e=ly(n,r,l);o.push(e)}}return new nh(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}}function lq(e,t,n){if("string"==typeof(n=(0,h.Ku)(n))){if(""===n)throw new N(S.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!nB(t)&&-1!==n.indexOf("/"))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);let r=t.path.child(j.fromString(n));if(!W.isDocumentKey(r))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return t8(e,new W(r))}if(n instanceof oX)return t8(e,n._key);throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${oQ(n)}.`)}function lB(e,t){if(!Array.isArray(e)||0===e.length)throw new N(S.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function lz(e,t){let n=function(e,t){for(let n of e)for(let e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new N(S.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new N(S.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}class l${convertValue(e,t="none"){switch(tX(e)){case 0:return null;case 1:return e.booleanValue;case 2:return tM(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(tO(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw x()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let n={};return tE(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){var t,n,r;return new lr(null===(r=null===(n=null===(t=e.fields)||void 0===t?void 0:t[tZ].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.map(e=>tM(e.doubleValue)))}convertGeoPoint(e){return new ln(tM(e.latitude),tM(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let n=tz(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(t$(e));default:return null}}convertTimestamp(e){let t=tL(e);return new z(t.seconds,t.nanos)}convertDocumentKey(e,t){let n=j.fromString(e);il(n)||x();let r=new tj(n.get(1),n.get(3)),i=new W(n.popFirst(5));return r.isEqual(t)||E(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}class lK extends l${constructor(e){super(),this.firestore=e}convertBytes(e){return new o7(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new oX(this.firestore,null,t)}}class lG{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class lj extends lN{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new lQ(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let n=this._document.data.field(lD("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class lQ extends lj{data(e={}){return super.data(e)}}class lH{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new lG(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new lQ(this._firestore,this._userDataWriter,n.key,n,new lG(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new N(S.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{let r=new lQ(e._firestore,e._userDataWriter,n.doc.key,n.doc,new lG(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{let r=new lQ(e._firestore,e._userDataWriter,t.doc.key,t.doc,new lG(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(s=(n=n.add(t.doc)).indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return x()}}(t.type),doc:r,oldIndex:i,newIndex:s}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}class lW extends l${constructor(e){super(),this.firestore=e}convertBytes(e){return new o7(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new oX(this.firestore,null,t)}}function lY(e){e=oH(e,oJ);let t=oH(e.firestore,o8),n=o9(t),r=new lW(t);return lk(e._query),(function(e,t,n={}){let r=new C;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new oL({next:n=>{s.su(),t.enqueueAndForget(()=>aZ(e,a)),n.fromCache&&"server"===r.source?i.reject(new N(S.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:e=>i.reject(e)}),a=new a1(n,s,{includeMetadataChanges:!0,Ta:!0});return aY(e,a)})(await oB(e),e.asyncQueue,t,n,r)),r.promise})(n,e._query).then(n=>new lH(t,r,e,n))}function lZ(e,...t){var n,r,i;let s,a,o;e=(0,h.Ku)(e);let l={includeMetadataChanges:!1,source:"default"},u=0;"object"!=typeof t[0]||o4(t[u])||(l=t[u],u++);let c={includeMetadataChanges:l.includeMetadataChanges,source:l.source};if(o4(t[u])){let e=t[u];t[u]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[u+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[u+2]=null===(i=e.complete)||void 0===i?void 0:i.bind(e)}if(e instanceof oX)a=oH(e.firestore,o8),o=nU(e._key.path),s={next:n=>{t[u]&&t[u](function(e,t,n){let r=n.docs.get(t._key),i=new lW(e);return new lj(e,i,t._key,r,new lG(n.hasPendingWrites,n.fromCache),t.converter)}(a,e,n))},error:t[u+1],complete:t[u+2]};else{let n=oH(e,oJ);a=oH(n.firestore,o8),o=n._query;let r=new lW(a);s={next:e=>{t[u]&&t[u](new lH(a,r,n,e))},error:t[u+1],complete:t[u+2]},lk(e._query)}return function(e,t,n,r){let i=new oL(r),s=new a1(t,i,n);return e.asyncQueue.enqueueAndForget(async()=>aY(await oB(e),s)),()=>{i.su(),e.asyncQueue.enqueueAndForget(async()=>aZ(await oB(e),s))}}(o9(a),o,c,s)}function lJ(e,t){if((e=(0,h.Ku)(e)).firestore!==t)throw new N(S.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}new WeakMap,function(e=!0){w=o.MF,(0,o.om)(new l.uA("firestore",(t,{instanceIdentifier:n,options:r})=>{let i=t.getProvider("app").getImmediate(),s=new o8(new V(t.getProvider("auth-internal")),new O(i,t.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new N(S.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new tj(e.options.projectId,t)}(i,n),i);return r=Object.assign({useFetchStreams:e},r),s._setSettings(r),s},"PUBLIC").setMultipleInstances(!0)),(0,o.KO)(g,p,void 0),(0,o.KO)(g,p,"esm2017")}()}}]);